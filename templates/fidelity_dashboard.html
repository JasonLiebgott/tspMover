<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Analysis Dashboard - Fidelity & Vanguard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            border-left: 4px solid #3498db;
            margin-bottom: 1rem;
        }
        .metric-card.good {
            border-left-color: #27ae60;
            background-color: #f8fff8;
        }
        .metric-card.neutral {
            border-left-color: #f39c12;
            background-color: #fffbf0;
        }
        .metric-card.bad {
            border-left-color: #e74c3c;
            background-color: #fff5f5;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .fund-card {
            border-radius: 8px;
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .fund-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .recommendation-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #666;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-low { background-color: #27ae60; }
        .status-moderate { background-color: #f39c12; }
        .status-high { background-color: #e74c3c; }
        .chart-img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .tab-content {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Fund Analysis Dashboard</h1>
                    <p class="lead">Risk-adjusted Fidelity & Vanguard fund analysis with automatic deduplication</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="card bg-transparent border-light">
                        <div class="card-body text-white">
                            <h5><i class="fas fa-piggy-bank"></i> FDRXX Money Market Baseline</h5>
                            <h2>{{ "%.1f"|format(dashboard.money_market_rate) }}%</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Fidelity Account Holder Advantages -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <h6><i class="fas fa-star"></i> Fidelity Account Holder Advantages</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>üÜì ZERO Funds</strong><br>
                            <small>0.00% expense ratio on FZROX, FZILX, FNILX, FZIPX</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üè† House Funds</strong><br>
                            <small>No transaction fees on all Fidelity funds</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üìà Commission-Free ETFs</strong><br>
                            <small>Most Vanguard & other ETFs trade fee-free</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üí∞ Cost Scoring</strong><br>
                            <small>Fund scores adjusted for your Fidelity account benefits</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeframe Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="fas fa-clock"></i> {{ timeframe_strategy.title }}</h5>
                                <p class="mb-0 text-muted">{{ timeframe_strategy.description }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-sm-8">
                                        <label for="timeframe" class="form-label">Investment Timeframe:</label>
                                        <div class="input-group">
                                            <select class="form-select" id="timeframe" onchange="updateTimeframe()">
                                                <option value="1" {% if dashboard.timeframe_years == 1 %}selected{% endif %}>1 Year</option>
                                                <option value="2" {% if dashboard.timeframe_years == 2 %}selected{% endif %}>2 Years</option>
                                                <option value="3" {% if dashboard.timeframe_years == 3 %}selected{% endif %}>3 Years</option>
                                                <option value="5" {% if dashboard.timeframe_years == 5 %}selected{% endif %}>5 Years</option>
                                                <option value="10" {% if dashboard.timeframe_years == 10 %}selected{% endif %}>10+ Years</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="updateTimeframe()" title="Refresh Analysis">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> Changing timeframe automatically updates all fund rankings and recommendations
                                        </small>
                                    </div>
                                    <div class="col-sm-4">
                                        <small class="text-muted">
                                            <strong>Strategy:</strong> {{ timeframe_strategy.strategy }}<br>
                                            <strong>Risk Tolerance:</strong> {{ timeframe_strategy.risk_tolerance }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Economic Conditions Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-globe"></i> Current Economic Environment</h3>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">Recession Risk</div>
                                <div class="metric-value">{{ "%.1f"|format(dashboard.economic_data.recession_score) }}/100</div>
                                <small class="text-muted">{{ dashboard.economic_data.recession_level }} Risk</small>
                            </div>
                            <div class="align-self-center">
                                {% if dashboard.economic_data.recession_level == "Low" %}
                                    <span class="status-indicator status-low"></span>
                                {% elif dashboard.economic_data.recession_level == "Moderate" %}
                                    <span class="status-indicator status-moderate"></span>
                                {% else %}
                                    <span class="status-indicator status-high"></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Inflation Risk</div>
                        <div class="metric-value">{{ dashboard.economic_data.inflation_risk }}</div>
                        <small class="text-muted">Current trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Dollar Strength</div>
                        <div class="metric-value">{{ dashboard.economic_data.dollar_strength }}</div>
                        <small class="text-muted">Recent trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Market Volatility</div>
                        <div class="metric-value">{{ dashboard.economic_data.market_volatility }}</div>
                        <small class="text-muted">Current level</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fund Recommendations Summary -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card good">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ dashboard.recommendations.good|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-up"></i> Good Opportunities</p>
                        <small class="text-muted">Recommended allocations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card neutral">
                    <div class="card-body text-center">
                        <h3 class="text-warning">{{ dashboard.recommendations.neutral|length }}</h3>
                        <p class="mb-0"><i class="fas fa-minus-circle"></i> Neutral Funds</p>
                        <small class="text-muted">Hold or consider</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card bad">
                    <div class="card-body text-center">
                        <h3 class="text-danger">{{ dashboard.recommendations.bad|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-down"></i> Avoid</p>
                        <small class="text-muted">High risk/low return</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeframe Strategy Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-bullseye"></i> Investment Strategy for {{ timeframe_strategy.title }}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie"></i> Recommended Allocation:</h6>
                                <p class="mb-2">{{ timeframe_strategy.recommended_allocation }}</p>
                                
                                <h6><i class="fas fa-exclamation-triangle"></i> Avoid:</h6>
                                <p class="text-warning">{{ timeframe_strategy.avoid }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Strategy Notes:</h6>
                                    <p class="mb-0">{{ timeframe_strategy.description }}</p>
                                    <hr>
                                    <small><strong>Risk Level:</strong> {{ timeframe_strategy.risk_tolerance }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Performance Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risk-return-tab" data-bs-toggle="tab" data-bs-target="#risk-return" type="button" role="tab">
                            <i class="fas fa-scatter-chart"></i> Risk vs Return
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab">
                            <i class="fas fa-layer-group"></i> Category Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="economic-tab" data-bs-toggle="tab" data-bs-target="#economic" type="button" role="tab">
                            <i class="fas fa-globe-americas"></i> Economic Conditions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">
                            <i class="fas fa-star"></i> Recommendations
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="chartTabContent">
                    <div class="tab-pane fade show active" id="performance" role="tabpanel">
                        <div class="chart-container">
                            <h4>Fund Performance vs FDRXX Money Market Rate</h4>
                            {% if dashboard.charts.fund_performance %}
                                <img src="data:image/png;base64,{{ dashboard.charts.fund_performance }}" class="chart-img" alt="Fund Performance Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="risk-return" role="tabpanel">
                        <div class="chart-container">
                            <h4>Risk vs Return Profile by Category</h4>
                            {% if dashboard.charts.risk_return_scatter %}
                                <img src="data:image/png;base64,{{ dashboard.charts.risk_return_scatter }}" class="chart-img" alt="Risk Return Scatter Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="category" role="tabpanel">
                        <div class="chart-container">
                            <h4>Category-wise Analysis</h4>
                            {% if dashboard.charts.category_analysis %}
                                <img src="data:image/png;base64,{{ dashboard.charts.category_analysis }}" class="chart-img" alt="Category Analysis Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="economic" role="tabpanel">
                        <div class="chart-container">
                            <h4>Economic Conditions Overview</h4>
                            {% if dashboard.charts.economic_conditions %}
                                <img src="data:image/png;base64,{{ dashboard.charts.economic_conditions }}" class="chart-img" alt="Economic Conditions Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="recommendations" role="tabpanel">
                        <div class="chart-container">
                            <h4>Recommendations Summary</h4>
                            {% if dashboard.charts.recommendations %}
                                <img src="data:image/png;base64,{{ dashboard.charts.recommendations }}" class="chart-img" alt="Recommendations Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Fund Recommendations -->
        <div class="row mt-4">
            <!-- Good Funds -->
            <div class="col-md-4">
                <h4 class="text-success"><i class="fas fa-thumbs-up"></i> Top Recommendations</h4>
                {% for fund in dashboard.recommendations.good[:6] %}
                <div class="fund-card card good">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-info recommendation-badge">{{ fund.category }}</span>
                                {% if fund.cost_analysis %}
                                <br><span class="badge 
                                    {% if fund.cost_analysis.cost_tier == 'Fidelity ZERO' %}bg-success
                                    {% elif fund.cost_analysis.cost_tier == 'Fidelity Premium' %}bg-primary
                                    {% elif fund.cost_analysis.cost_tier == 'Commission-Free ETF' %}bg-info
                                    {% else %}bg-secondary{% endif %} mt-1">
                                    {{ fund.cost_analysis.cost_tier }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-success">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Neutral Funds -->
            <div class="col-md-4">
                <h4 class="text-warning"><i class="fas fa-minus-circle"></i> Neutral Consideration</h4>
                {% for fund in dashboard.recommendations.neutral[:6] %}
                <div class="fund-card card neutral">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-warning recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-warning">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Bad Funds -->
            <div class="col-md-4">
                <h4 class="text-danger"><i class="fas fa-thumbs-down"></i> Avoid These</h4>
                {% for fund in dashboard.recommendations.bad[:6] %}
                <div class="fund-card card bad">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-danger recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-danger">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Duplicate Funds Section (Collapsed by Default) -->
        {% if dashboard.recommendations.duplicates %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#duplicatesSection" aria-expanded="false" aria-controls="duplicatesSection" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="fas fa-copy"></i> Duplicate Funds Filtered Out 
                            <span class="badge bg-warning">{{ dashboard.recommendations.duplicates|length }}</span>
                            <small class="float-end"><i class="fas fa-chevron-down"></i> Click to expand</small>
                        </h5>
                    </div>
                    <div class="collapse" id="duplicatesSection">
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="fas fa-info-circle"></i> These funds have significant overlap with higher-ranked funds and are filtered from main recommendations to avoid duplication.
                            </p>
                            <div class="row">
                                {% for fund in dashboard.recommendations.duplicates %}
                                <div class="col-md-4 mb-3">
                                    <div class="card border-warning fund-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title">{{ fund.symbol }}</h6>
                                                    <p class="card-text small text-muted">{{ fund.name }}</p>
                                                    <span class="badge bg-warning recommendation-badge">{{ fund.category }}</span>
                                                    {% if fund.duplicate_of %}
                                                    <br><small class="text-warning mt-1">
                                                        <i class="fas fa-arrow-right"></i> Similar to {{ fund.duplicate_of }} 
                                                        ({{ "%.0f"|format(fund.overlap_score * 100) }}% overlap)
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    <div class="metric-value text-warning">{{ "%.1f"|format(fund.score) }}</div>
                                                    <div class="metric-label">Score</div>
                                                </div>
                                            </div>
                                            {% if fund.risk_metrics %}
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        Vol vs S&P: 
                                                        {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                                            <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                                        {% else %}
                                                            <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Portfolio Allocation Recommendations -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success bg-opacity-10">
                        <h4 class="mb-0 text-success">
                            <i class="fas fa-pie-chart"></i> Multi-Year Portfolio Allocation Strategy
                        </h4>
                        <small class="text-muted">Optimal fund allocation percentages for your next 4 years of investing</small>
                    </div>
                    <div class="card-body">
                        <!-- Investment Amount Calculator -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-primary">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label for="investmentAmount" class="form-label mb-0">
                                                <strong><i class="fas fa-dollar-sign"></i> Investment Amount:</strong>
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="investmentAmount" value="10000" min="100" max="10000000" step="100" onchange="updatePortfolioCalculations()">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> Enter your investment amount to see exact purchase amounts for each fund
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            {% for key, allocation in portfolio_allocations.items() %}
                            <div class="col-md-3 mb-4">
                                <div class="card h-100 border-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}">
                                    <div class="card-header bg-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }} bg-opacity-10">
                                        <h6 class="mb-0 text-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}">
                                            <i class="fas fa-calendar-alt"></i> {{ allocation.timeframe }} Year{{ 's' if allocation.timeframe > 1 else '' }}
                                        </h6>
                                        <small class="text-muted">{{ allocation.strategy }} | {{ allocation.risk_level }} Risk</small>
                                    </div>
                                    <div class="card-body p-3">
                                        <p class="small text-muted mb-3">{{ allocation.description }}</p>
                                        
                                        <!-- Purchase Instructions -->
                                        <div class="alert alert-light mb-3 purchase-instructions" data-timeframe="{{ allocation.timeframe }}">
                                            <h6 class="mb-2"><i class="fas fa-shopping-cart"></i> Purchase Plan</h6>
                                            <div class="purchase-list">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                            <div class="border-top pt-2 mt-2">
                                                <small class="text-muted">
                                                    <strong>Total Investment:</strong> <span class="total-amount">$10,000</span>
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <!-- Allocation Chart -->
                                        <div class="allocation-chart mb-3">
                                            {% for fund_alloc in allocation.funds %}
                                            <div class="d-flex justify-content-between align-items-center mb-2 fund-allocation" 
                                                 data-timeframe="{{ allocation.timeframe }}" 
                                                 data-symbol="{{ fund_alloc.fund.symbol }}" 
                                                 data-allocation="{{ fund_alloc.allocation }}"
                                                 data-category="{{ fund_alloc.category }}">
                                                <div class="flex-grow-1">
                                                    <strong class="small">{{ fund_alloc.fund.symbol }}</strong>
                                                    <div class="small text-muted">{{ fund_alloc.category }}</div>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-secondary">{{ "%.0f"|format(fund_alloc.allocation) }}%</span>
                                                </div>
                                            </div>
                                            <!-- Progress Bar -->
                                            <div class="progress mb-2" style="height: 6px;">
                                                <div class="progress-bar bg-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}" 
                                                     style="width: {{ fund_alloc.allocation }}%"></div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- Summary -->
                                        <div class="border-top pt-2">
                                            <small class="text-muted">
                                                <strong>Total Allocated:</strong> {{ "%.0f"|format(allocation.total_allocation) }}%<br>
                                                <strong>Funds Used:</strong> {{ allocation.funds|length }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Master Purchase List - Consolidated across all years -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-calculator"></i> Master Purchase List - Total Allocation Across All 4 Years
                                        </h5>
                                        <small class="text-muted">Consolidated fund purchases needed to implement all timeframe strategies</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div id="masterPurchaseList">
                                                    <!-- Will be populated by JavaScript -->
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-shopping-cart"></i> Total Investment Summary
                                                        </h6>
                                                        <hr>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 1:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear1">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 2:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear2">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 3:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear3">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 4:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear4">$10,000</div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-6"><strong>Grand Total:</strong></div>
                                                            <div class="col-6 text-end"><strong id="grandTotal">$40,000</strong></div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-6"><strong>Unique Funds:</strong></div>
                                                            <div class="col-6 text-end" id="uniqueFundCount">-</div>
                                                        </div>
                                                        
                                                        <button class="btn btn-warning w-100 mt-3" onclick="copyMasterPurchaseList()">
                                                            <i class="fas fa-copy"></i> Copy Master List
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Portfolio Strategy Summary -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-light">
                                    <h6><i class="fas fa-lightbulb"></i> Portfolio Strategy Guidelines</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>üìÖ 1 Year:</strong> Capital preservation focus with bonds and stable funds for near-term goals.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 2 Years:</strong> Conservative growth balancing stability with modest equity exposure.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 3 Years:</strong> Balanced approach with diversified equity and bond mix for medium-term growth.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 4 Years:</strong> Growth-focused portfolio with higher equity allocation for long-term appreciation.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle"></i> Analysis Summary</h5>
                        <p><strong>Methodology:</strong> This dashboard analyzes Fidelity and Vanguard index funds based on risk-adjusted returns, economic conditions, and current market environment. Funds are scored considering excess returns over FDRXX money market rates, volatility, Sharpe ratios, and adjustments for recession risk, inflation, and dollar strength. <strong>Fund scores are enhanced for Fidelity account holders, giving preference to Fidelity ZERO funds (0.00% expense ratio) and other cost advantages.</strong> <strong>Duplicate funds with significant overlap are automatically filtered out to prevent redundant investments.</strong></p>
                        
                        <p><strong>Current Environment:</strong> 
                            Recession Risk: {{ dashboard.economic_data.recession_level }} | 
                            Inflation Risk: {{ dashboard.economic_data.inflation_risk }} | 
                            Dollar: {{ dashboard.economic_data.dollar_strength }} | 
                            Volatility: {{ dashboard.economic_data.market_volatility }}
                        </p>
                        
                        <p><strong>Baseline:</strong> FDRXX money market rate of {{ "%.2f"|format(dashboard.money_market_rate) }}% used as risk-free return benchmark.</p>
                        
                        <p class="text-muted mb-0"><small>Last updated: <span id="current-time"></span> | Data sources: Yahoo Finance, FRED Economic Data</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script>
        // Auto-refresh every 5 minutes during market hours
        const refreshInterval = 5 * 60 * 1000; // 5 minutes
        
        function isMarketHours() {
            const now = moment();
            const hour = now.hour();
            const day = now.day();
            
            // Simple check for US market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
            return day >= 1 && day <= 5 && hour >= 9 && hour <= 16;
        }
        
        if (isMarketHours()) {
            setInterval(() => {
                location.reload();
            }, refreshInterval);
        }
        
        // Add tooltips for better UX
        document.addEventListener('DOMContentLoaded', function() {
            // Set current time
            const currentTime = moment().format('MMMM Do YYYY, h:mm:ss a');
            document.getElementById('current-time').textContent = currentTime;
            
            // Initialize tooltips if needed
            console.log('Fidelity Dashboard loaded');
        });
        
        // Timeframe update function
        function updateTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            const refreshBtn = document.querySelector('button[onclick="updateTimeframe()"]');
            
            // Show loading indicator
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }
            
            // Add a small delay to show loading indicator
            setTimeout(() => {
                window.location.href = `/?timeframe=${timeframe}`;
            }, 200);
        }
        
        // Add visual feedback when dropdown changes
        document.addEventListener('DOMContentLoaded', function() {
            const timeframeSelect = document.getElementById('timeframe');
            if (timeframeSelect) {
                timeframeSelect.addEventListener('change', function() {
                    this.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 300);
                });
            }
        });
        
        // Portfolio calculation functions
        function updatePortfolioCalculations() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            
            // Update all portfolio calculations
            const instructions = document.querySelectorAll('.purchase-instructions');
            instructions.forEach(instruction => {
                const timeframe = instruction.getAttribute('data-timeframe');
                updateTimeframeCalculation(timeframe, investmentAmount);
            });
            
            // Update master purchase list
            updateMasterPurchaseList(investmentAmount);
        }
        
        function updateTimeframeCalculation(timeframe, totalAmount) {
            const instructionDiv = document.querySelector(`[data-timeframe="${timeframe}"] .purchase-list`);
            const totalAmountSpan = document.querySelector(`[data-timeframe="${timeframe}"] .total-amount`);
            
            if (!instructionDiv) return;
            
            // Get all fund allocations for this timeframe
            const fundAllocations = document.querySelectorAll(`[data-timeframe="${timeframe}"].fund-allocation`);
            
            let purchaseHtml = '';
            let runningTotal = 0;
            
            fundAllocations.forEach(allocation => {
                const symbol = allocation.getAttribute('data-symbol');
                const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                const category = allocation.getAttribute('data-category');
                const amount = Math.round(totalAmount * (percentage / 100));
                
                runningTotal += amount;
                
                purchaseHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <strong class="small">${symbol}</strong>
                            <span class="text-muted small">(${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">$${amount.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
            });
            
            // Add any remaining amount to the largest allocation if there's a rounding difference
            const difference = totalAmount - runningTotal;
            if (Math.abs(difference) > 0) {
                purchaseHtml += `
                    <div class="text-muted small mt-1">
                        ${difference > 0 ? `Remaining: $${difference}` : `Over by: $${Math.abs(difference)}`}
                    </div>
                `;
            }
            
            instructionDiv.innerHTML = purchaseHtml;
            
            if (totalAmountSpan) {
                totalAmountSpan.textContent = `$${totalAmount.toLocaleString()}`;
            }
        }
        
        // Initialize portfolio calculations on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing portfolio calculations...');
            
            // Small delay to ensure all elements are properly rendered
            setTimeout(() => {
                updatePortfolioCalculations();
                console.log('Portfolio calculations updated');
            }, 100);
            
            // Add copy-to-clipboard functionality for purchase instructions
            const purchaseInstructions = document.querySelectorAll('.purchase-instructions');
            purchaseInstructions.forEach(instruction => {
                const timeframe = instruction.getAttribute('data-timeframe');
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Purchase List';
                copyBtn.onclick = () => copyPurchaseList(timeframe);
                instruction.appendChild(copyBtn);
            });
        });
        
        function copyPurchaseList(timeframe) {
            const instructionDiv = document.querySelector(`[data-timeframe="${timeframe}"] .purchase-list`);
            const totalAmountSpan = document.querySelector(`[data-timeframe="${timeframe}"] .total-amount`);
            
            if (!instructionDiv) return;
            
            // Create text version of purchase list
            const fundAllocations = document.querySelectorAll(`[data-timeframe="${timeframe}"].fund-allocation`);
            const totalAmount = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            
            let copyText = `${timeframe} Year Portfolio Allocation (${totalAmountSpan.textContent}):\n\n`;
            
            fundAllocations.forEach(allocation => {
                const symbol = allocation.getAttribute('data-symbol');
                const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                const amount = Math.round(totalAmount * (percentage / 100));
                
                copyText += `${symbol}: $${amount.toLocaleString()} (${percentage.toFixed(0)}%)\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(copyText).then(() => {
                // Show success feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.className = 'btn btn-sm btn-success mt-2';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-sm btn-outline-secondary mt-2';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function updateMasterPurchaseList(totalAmountPerYear) {
            console.log('Starting updateMasterPurchaseList with amount:', totalAmountPerYear);
            
            // Collect all fund allocations across all timeframes
            const masterFunds = {};
            const yearTotals = {};
            
            // Process each timeframe (1-4 years)
            for (let year = 1; year <= 4; year++) {
                const fundAllocations = document.querySelectorAll(`[data-timeframe="${year}"].fund-allocation`);
                console.log(`Year ${year}: Found ${fundAllocations.length} fund allocations`);
                yearTotals[year] = totalAmountPerYear;
                
                fundAllocations.forEach(allocation => {
                    const symbol = allocation.getAttribute('data-symbol');
                    const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                    const category = allocation.getAttribute('data-category');
                    const amount = Math.round(totalAmountPerYear * (percentage / 100));
                    
                    console.log(`  Year ${year}: ${symbol} - ${percentage}% = $${amount.toLocaleString()}`);
                    
                    if (!masterFunds[symbol]) {
                        masterFunds[symbol] = {
                            category: category,
                            totalAmount: 0,
                            yearlyAmounts: {},
                            totalPercentage: 0
                        };
                    }
                    
                    masterFunds[symbol].totalAmount += amount;
                    masterFunds[symbol].yearlyAmounts[year] = amount;
                });
            }
            
            // Calculate total across all years
            const grandTotal = totalAmountPerYear * 4;
            
            // Sort funds by total amount (largest first)
            const sortedFunds = Object.entries(masterFunds)
                .sort(([,a], [,b]) => b.totalAmount - a.totalAmount);
            
            // Generate master purchase list HTML
            let masterHtml = '<h6 class="mb-3"><i class="fas fa-list"></i> Consolidated Fund Purchase List</h6>';
            
            sortedFunds.forEach(([symbol, data]) => {
                const totalPercentage = (data.totalAmount / grandTotal) * 100;
                console.log(`Processing fund ${symbol}:`, data);
                
                masterHtml += `
                    <div class="row align-items-center mb-3 p-2 border rounded">
                        <div class="col-md-3">
                            <strong class="h6 mb-0">${symbol}</strong>
                            <div class="small text-muted">${data.category}</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-success fs-6">$${data.totalAmount.toLocaleString()}</span>
                            <div class="small text-muted">${totalPercentage.toFixed(1)}% of total</div>
                        </div>
                        <div class="col-md-6">
                            <div class="small text-muted">Yearly breakdown:</div>
                            <div class="d-flex flex-wrap">
                `;
                
                for (let year = 1; year <= 4; year++) {
                    const yearAmount = data.yearlyAmounts[year] || 0;
                    console.log(`  Yearly breakdown for ${symbol}: Year ${year} = $${yearAmount.toLocaleString()}`);
                    if (yearAmount > 0) {
                        masterHtml += `
                            <span class="badge bg-secondary me-1 mb-1">
                                Y${year}: $${yearAmount.toLocaleString()}
                            </span>
                        `;
                    }
                }
                
                masterHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Update master purchase list
            document.getElementById('masterPurchaseList').innerHTML = masterHtml;
            
            // Update summary totals
            document.getElementById('totalYear1').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear2').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear3').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear4').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toLocaleString()}`;
            document.getElementById('uniqueFundCount').textContent = sortedFunds.length;
        }
        
        function copyMasterPurchaseList() {
            const totalAmountPerYear = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            const grandTotal = totalAmountPerYear * 4;
            
            // Collect all fund data
            const masterFunds = {};
            
            for (let year = 1; year <= 4; year++) {
                const fundAllocations = document.querySelectorAll(`[data-timeframe="${year}"].fund-allocation`);
                
                fundAllocations.forEach(allocation => {
                    const symbol = allocation.getAttribute('data-symbol');
                    const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                    const category = allocation.getAttribute('data-category');
                    const amount = Math.round(totalAmountPerYear * (percentage / 100));
                    
                    if (!masterFunds[symbol]) {
                        masterFunds[symbol] = {
                            category: category,
                            totalAmount: 0,
                            yearlyAmounts: {}
                        };
                    }
                    
                    masterFunds[symbol].totalAmount += amount;
                    masterFunds[symbol].yearlyAmounts[year] = amount;
                });
            }
            
            // Sort by total amount
            const sortedFunds = Object.entries(masterFunds)
                .sort(([,a], [,b]) => b.totalAmount - a.totalAmount);
            
            // Create copy text
            let copyText = `MASTER FUND PURCHASE LIST (Total: $${grandTotal.toLocaleString()})\n`;
            copyText += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            sortedFunds.forEach(([symbol, data]) => {
                const totalPercentage = (data.totalAmount / grandTotal) * 100;
                copyText += `${symbol} (${data.category}): $${data.totalAmount.toLocaleString()} (${totalPercentage.toFixed(1)}%)\n`;
                
                // Add yearly breakdown
                copyText += `  ‚îî‚îÄ Breakdown: `;
                for (let year = 1; year <= 4; year++) {
                    const yearAmount = data.yearlyAmounts[year] || 0;
                    if (yearAmount > 0) {
                        copyText += `Y${year}:$${yearAmount.toLocaleString()} `;
                    }
                }
                copyText += `\n\n`;
            });
            
            copyText += `\nSUMMARY:\n`;
            copyText += `‚Ä¢ Per Year Investment: $${totalAmountPerYear.toLocaleString()}\n`;
            copyText += `‚Ä¢ Total 4-Year Investment: $${grandTotal.toLocaleString()}\n`;
            copyText += `‚Ä¢ Unique Funds: ${sortedFunds.length}\n`;
            copyText += `‚Ä¢ Generated: ${new Date().toLocaleString()}\n`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(copyText).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied Master List!';
                btn.className = 'btn btn-success w-100 mt-3';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-warning w-100 mt-3';
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy master list: ', err);
            });
        }
    </script>
</body>
</html>