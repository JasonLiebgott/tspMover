<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fidelity Fund Analysis Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            border-left: 4px solid #3498db;
            margin-bottom: 1rem;
        }
        .metric-card.good {
            border-left-color: #27ae60;
            background-color: #f8fff8;
        }
        .metric-card.neutral {
            border-left-color: #f39c12;
            background-color: #fffbf0;
        }
        .metric-card.bad {
            border-left-color: #e74c3c;
            background-color: #fff5f5;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .fund-card {
            border-radius: 8px;
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .fund-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .recommendation-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #666;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-low { background-color: #27ae60; }
        .status-moderate { background-color: #f39c12; }
        .status-high { background-color: #e74c3c; }
        .chart-img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .tab-content {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Fidelity Fund Analysis Dashboard</h1>
                    <p class="lead">Risk-adjusted fund analysis for optimal allocation beyond FDRXX money market rates</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="card bg-transparent border-light">
                        <div class="card-body text-white">
                            <h5><i class="fas fa-piggy-bank"></i> FDRXX Money Market Baseline</h5>
                            <h2>{{ "%.1f"|format(dashboard.money_market_rate) }}%</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Timeframe Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="fas fa-clock"></i> {{ timeframe_strategy.title }}</h5>
                                <p class="mb-0 text-muted">{{ timeframe_strategy.description }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-sm-8">
                                        <label for="timeframe" class="form-label">Investment Timeframe:</label>
                                        <div class="input-group">
                                            <select class="form-select" id="timeframe" onchange="updateTimeframe()">
                                                <option value="1" {% if dashboard.timeframe_years == 1 %}selected{% endif %}>1 Year</option>
                                                <option value="2" {% if dashboard.timeframe_years == 2 %}selected{% endif %}>2 Years</option>
                                                <option value="3" {% if dashboard.timeframe_years == 3 %}selected{% endif %}>3 Years</option>
                                                <option value="5" {% if dashboard.timeframe_years == 5 %}selected{% endif %}>5 Years</option>
                                                <option value="10" {% if dashboard.timeframe_years == 10 %}selected{% endif %}>10+ Years</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="updateTimeframe()" title="Refresh Analysis">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> Changing timeframe automatically updates all fund rankings and recommendations
                                        </small>
                                    </div>
                                    <div class="col-sm-4">
                                        <small class="text-muted">
                                            <strong>Strategy:</strong> {{ timeframe_strategy.strategy }}<br>
                                            <strong>Risk Tolerance:</strong> {{ timeframe_strategy.risk_tolerance }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Economic Conditions Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-globe"></i> Current Economic Environment</h3>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">Recession Risk</div>
                                <div class="metric-value">{{ "%.1f"|format(dashboard.economic_data.recession_score) }}/100</div>
                                <small class="text-muted">{{ dashboard.economic_data.recession_level }} Risk</small>
                            </div>
                            <div class="align-self-center">
                                {% if dashboard.economic_data.recession_level == "Low" %}
                                    <span class="status-indicator status-low"></span>
                                {% elif dashboard.economic_data.recession_level == "Moderate" %}
                                    <span class="status-indicator status-moderate"></span>
                                {% else %}
                                    <span class="status-indicator status-high"></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Inflation Risk</div>
                        <div class="metric-value">{{ dashboard.economic_data.inflation_risk }}</div>
                        <small class="text-muted">Current trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Dollar Strength</div>
                        <div class="metric-value">{{ dashboard.economic_data.dollar_strength }}</div>
                        <small class="text-muted">Recent trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Market Volatility</div>
                        <div class="metric-value">{{ dashboard.economic_data.market_volatility }}</div>
                        <small class="text-muted">Current level</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fund Recommendations Summary -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card good">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ dashboard.recommendations.good|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-up"></i> Good Opportunities</p>
                        <small class="text-muted">Recommended allocations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card neutral">
                    <div class="card-body text-center">
                        <h3 class="text-warning">{{ dashboard.recommendations.neutral|length }}</h3>
                        <p class="mb-0"><i class="fas fa-minus-circle"></i> Neutral Funds</p>
                        <small class="text-muted">Hold or consider</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card bad">
                    <div class="card-body text-center">
                        <h3 class="text-danger">{{ dashboard.recommendations.bad|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-down"></i> Avoid</p>
                        <small class="text-muted">High risk/low return</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeframe Strategy Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-bullseye"></i> Investment Strategy for {{ timeframe_strategy.title }}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie"></i> Recommended Allocation:</h6>
                                <p class="mb-2">{{ timeframe_strategy.recommended_allocation }}</p>
                                
                                <h6><i class="fas fa-exclamation-triangle"></i> Avoid:</h6>
                                <p class="text-warning">{{ timeframe_strategy.avoid }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Strategy Notes:</h6>
                                    <p class="mb-0">{{ timeframe_strategy.description }}</p>
                                    <hr>
                                    <small><strong>Risk Level:</strong> {{ timeframe_strategy.risk_tolerance }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Performance Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risk-return-tab" data-bs-toggle="tab" data-bs-target="#risk-return" type="button" role="tab">
                            <i class="fas fa-scatter-chart"></i> Risk vs Return
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab">
                            <i class="fas fa-layer-group"></i> Category Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="economic-tab" data-bs-toggle="tab" data-bs-target="#economic" type="button" role="tab">
                            <i class="fas fa-globe-americas"></i> Economic Conditions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">
                            <i class="fas fa-star"></i> Recommendations
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="chartTabContent">
                    <div class="tab-pane fade show active" id="performance" role="tabpanel">
                        <div class="chart-container">
                            <h4>Fund Performance vs FDRXX Money Market Rate</h4>
                            {% if dashboard.charts.fund_performance %}
                                <img src="data:image/png;base64,{{ dashboard.charts.fund_performance }}" class="chart-img" alt="Fund Performance Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="risk-return" role="tabpanel">
                        <div class="chart-container">
                            <h4>Risk vs Return Profile by Category</h4>
                            {% if dashboard.charts.risk_return_scatter %}
                                <img src="data:image/png;base64,{{ dashboard.charts.risk_return_scatter }}" class="chart-img" alt="Risk Return Scatter Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="category" role="tabpanel">
                        <div class="chart-container">
                            <h4>Category-wise Analysis</h4>
                            {% if dashboard.charts.category_analysis %}
                                <img src="data:image/png;base64,{{ dashboard.charts.category_analysis }}" class="chart-img" alt="Category Analysis Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="economic" role="tabpanel">
                        <div class="chart-container">
                            <h4>Economic Conditions Overview</h4>
                            {% if dashboard.charts.economic_conditions %}
                                <img src="data:image/png;base64,{{ dashboard.charts.economic_conditions }}" class="chart-img" alt="Economic Conditions Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="recommendations" role="tabpanel">
                        <div class="chart-container">
                            <h4>Recommendations Summary</h4>
                            {% if dashboard.charts.recommendations %}
                                <img src="data:image/png;base64,{{ dashboard.charts.recommendations }}" class="chart-img" alt="Recommendations Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Fund Recommendations -->
        <div class="row mt-4">
            <!-- Good Funds -->
            <div class="col-md-4">
                <h4 class="text-success"><i class="fas fa-thumbs-up"></i> Top Recommendations</h4>
                {% for fund in dashboard.recommendations.good[:6] %}
                <div class="fund-card card good">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-info recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-success">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Volatility: {{ "%.1f"|format(fund.risk_metrics.volatility) }}%</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Neutral Funds -->
            <div class="col-md-4">
                <h4 class="text-warning"><i class="fas fa-minus-circle"></i> Neutral Consideration</h4>
                {% for fund in dashboard.recommendations.neutral[:6] %}
                <div class="fund-card card neutral">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-warning recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-warning">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Volatility: {{ "%.1f"|format(fund.risk_metrics.volatility) }}%</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Bad Funds -->
            <div class="col-md-4">
                <h4 class="text-danger"><i class="fas fa-thumbs-down"></i> Avoid These</h4>
                {% for fund in dashboard.recommendations.bad[:6] %}
                <div class="fund-card card bad">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-danger recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-danger">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Volatility: {{ "%.1f"|format(fund.risk_metrics.volatility) }}%</small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle"></i> Analysis Summary</h5>
                        <p><strong>Methodology:</strong> This dashboard analyzes Fidelity index funds based on risk-adjusted returns, economic conditions, and current market environment. Funds are scored considering excess returns over FDRXX money market rates, volatility, Sharpe ratios, and adjustments for recession risk, inflation, and dollar strength.</p>
                        
                        <p><strong>Current Environment:</strong> 
                            Recession Risk: {{ dashboard.economic_data.recession_level }} | 
                            Inflation Risk: {{ dashboard.economic_data.inflation_risk }} | 
                            Dollar: {{ dashboard.economic_data.dollar_strength }} | 
                            Volatility: {{ dashboard.economic_data.market_volatility }}
                        </p>
                        
                        <p><strong>Baseline:</strong> FDRXX money market rate of {{ "%.2f"|format(dashboard.money_market_rate) }}% used as risk-free return benchmark.</p>
                        
                        <p class="text-muted mb-0"><small>Last updated: <span id="current-time"></span> | Data sources: Yahoo Finance, FRED Economic Data</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script>
        // Auto-refresh every 5 minutes during market hours
        const refreshInterval = 5 * 60 * 1000; // 5 minutes
        
        function isMarketHours() {
            const now = moment();
            const hour = now.hour();
            const day = now.day();
            
            // Simple check for US market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
            return day >= 1 && day <= 5 && hour >= 9 && hour <= 16;
        }
        
        if (isMarketHours()) {
            setInterval(() => {
                location.reload();
            }, refreshInterval);
        }
        
        // Add tooltips for better UX
        document.addEventListener('DOMContentLoaded', function() {
            // Set current time
            const currentTime = moment().format('MMMM Do YYYY, h:mm:ss a');
            document.getElementById('current-time').textContent = currentTime;
            
            // Initialize tooltips if needed
            console.log('Fidelity Dashboard loaded');
        });
        
        // Timeframe update function
        function updateTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            const refreshBtn = document.querySelector('button[onclick="updateTimeframe()"]');
            
            // Show loading indicator
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }
            
            // Add a small delay to show loading indicator
            setTimeout(() => {
                window.location.href = `/?timeframe=${timeframe}`;
            }, 200);
        }
        
        // Add visual feedback when dropdown changes
        document.addEventListener('DOMContentLoaded', function() {
            const timeframeSelect = document.getElementById('timeframe');
            if (timeframeSelect) {
                timeframeSelect.addEventListener('change', function() {
                    this.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 300);
                });
            }
        });
    </script>
</body>
</html>