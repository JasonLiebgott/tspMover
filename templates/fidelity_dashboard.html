<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fund Analysis Dashboard - Fidelity & Vanguard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        .dashboard-header {
            background: linear-gradient(135deg, #2c3e50, #3498db);
            color: white;
            padding: 2rem 0;
            margin-bottom: 2rem;
        }
        .metric-card {
            border-left: 4px solid #3498db;
            margin-bottom: 1rem;
        }
        .metric-card.good {
            border-left-color: #27ae60;
            background-color: #f8fff8;
        }
        .metric-card.neutral {
            border-left-color: #f39c12;
            background-color: #fffbf0;
        }
        .metric-card.bad {
            border-left-color: #e74c3c;
            background-color: #fff5f5;
        }
        .chart-container {
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            padding: 1rem;
            margin-bottom: 2rem;
        }
        .fund-card {
            border-radius: 8px;
            transition: transform 0.2s;
            margin-bottom: 1rem;
        }
        .fund-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        .recommendation-badge {
            font-size: 0.8rem;
            padding: 0.3rem 0.6rem;
        }
        .metric-value {
            font-size: 1.5rem;
            font-weight: bold;
        }
        .metric-label {
            font-size: 0.9rem;
            color: #666;
        }
        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }
        .status-low { background-color: #27ae60; }
        .status-moderate { background-color: #f39c12; }
        .status-high { background-color: #e74c3c; }
        .chart-img {
            max-width: 100%;
            height: auto;
            border-radius: 4px;
        }
        .tab-content {
            margin-top: 1rem;
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="container">
            <div class="row">
                <div class="col-md-8">
                    <h1><i class="fas fa-chart-line"></i> Fund Analysis Dashboard</h1>
                    <p class="lead">Risk-adjusted Fidelity & Vanguard fund analysis with automatic deduplication</p>
                </div>
                <div class="col-md-4 text-end">
                    <div class="card bg-transparent border-light">
                        <div class="card-body text-white">
                            <h5><i class="fas fa-piggy-bank"></i> FDRXX Money Market Baseline</h5>
                            <h2>{{ "%.1f"|format(dashboard.money_market_rate) }}%</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container-fluid">
        <!-- Fidelity Account Holder Advantages -->
        <div class="row mb-3">
            <div class="col-12">
                <div class="alert alert-info" role="alert">
                    <h6><i class="fas fa-star"></i> Fidelity Account Holder Advantages</h6>
                    <div class="row">
                        <div class="col-md-3">
                            <strong>üÜì ZERO Funds</strong><br>
                            <small>0.00% expense ratio on FZROX, FZILX, FNILX, FZIPX</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üè† House Funds</strong><br>
                            <small>No transaction fees on all Fidelity funds</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üìà Commission-Free ETFs</strong><br>
                            <small>Most Vanguard & other ETFs trade fee-free</small>
                        </div>
                        <div class="col-md-3">
                            <strong>üí∞ Cost Scoring</strong><br>
                            <small>Fund scores adjusted for your Fidelity account benefits</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeframe Selection -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <h5 class="mb-0"><i class="fas fa-clock"></i> {{ timeframe_strategy.title }}</h5>
                                <p class="mb-0 text-muted">{{ timeframe_strategy.description }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="row">
                                    <div class="col-sm-8">
                                        <label for="timeframe" class="form-label">Investment Timeframe:</label>
                                        <div class="input-group">
                                            <select class="form-select" id="timeframe" onchange="updateTimeframe()">
                                                <option value="1" {% if dashboard.timeframe_years == 1 %}selected{% endif %}>1 Year</option>
                                                <option value="2" {% if dashboard.timeframe_years == 2 %}selected{% endif %}>2 Years</option>
                                                <option value="3" {% if dashboard.timeframe_years == 3 %}selected{% endif %}>3 Years</option>
                                                <option value="5" {% if dashboard.timeframe_years == 5 %}selected{% endif %}>5 Years</option>
                                                <option value="10" {% if dashboard.timeframe_years == 10 %}selected{% endif %}>10+ Years</option>
                                            </select>
                                            <button class="btn btn-outline-primary" type="button" onclick="updateTimeframe()" title="Refresh Analysis">
                                                <i class="fas fa-sync-alt"></i>
                                            </button>
                                        </div>
                                        <small class="text-muted">
                                            <i class="fas fa-info-circle"></i> Changing timeframe automatically updates all fund rankings and recommendations
                                        </small>
                                    </div>
                                    <div class="col-sm-4">
                                        <small class="text-muted">
                                            <strong>Strategy:</strong> {{ timeframe_strategy.strategy }}<br>
                                            <strong>Risk Tolerance:</strong> {{ timeframe_strategy.risk_tolerance }}
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <!-- Economic Conditions Summary -->
        <div class="row mb-4">
            <div class="col-12">
                <h3><i class="fas fa-globe"></i> Current Economic Environment</h3>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="metric-label">Recession Risk</div>
                                <div class="metric-value">{{ "%.1f"|format(dashboard.economic_data.recession_score) }}/100</div>
                                <small class="text-muted">{{ dashboard.economic_data.recession_level }} Risk</small>
                            </div>
                            <div class="align-self-center">
                                {% if dashboard.economic_data.recession_level == "Low" %}
                                    <span class="status-indicator status-low"></span>
                                {% elif dashboard.economic_data.recession_level == "Moderate" %}
                                    <span class="status-indicator status-moderate"></span>
                                {% else %}
                                    <span class="status-indicator status-high"></span>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Inflation Risk</div>
                        <div class="metric-value">{{ dashboard.economic_data.inflation_risk }}</div>
                        <small class="text-muted">Current trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Dollar Strength</div>
                        <div class="metric-value">{{ dashboard.economic_data.dollar_strength }}</div>
                        <small class="text-muted">Recent trend</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card">
                    <div class="card-body">
                        <div class="metric-label">Market Volatility</div>
                        <div class="metric-value">{{ dashboard.economic_data.market_volatility }}</div>
                        <small class="text-muted">Current level</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Fund Recommendations Summary -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card metric-card good">
                    <div class="card-body text-center">
                        <h3 class="text-success">{{ dashboard.recommendations.good|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-up"></i> Good Opportunities</p>
                        <small class="text-muted">Recommended allocations</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card neutral">
                    <div class="card-body text-center">
                        <h3 class="text-warning">{{ dashboard.recommendations.neutral|length }}</h3>
                        <p class="mb-0"><i class="fas fa-minus-circle"></i> Neutral Funds</p>
                        <small class="text-muted">Hold or consider</small>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card metric-card bad">
                    <div class="card-body text-center">
                        <h3 class="text-danger">{{ dashboard.recommendations.bad|length }}</h3>
                        <p class="mb-0"><i class="fas fa-thumbs-down"></i> Avoid</p>
                        <small class="text-muted">High risk/low return</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Timeframe Strategy Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h4><i class="fas fa-bullseye"></i> Investment Strategy for {{ timeframe_strategy.title }}</h4>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6><i class="fas fa-chart-pie"></i> Recommended Allocation:</h6>
                                <p class="mb-2">{{ timeframe_strategy.recommended_allocation }}</p>
                                
                                <h6><i class="fas fa-exclamation-triangle"></i> Avoid:</h6>
                                <p class="text-warning">{{ timeframe_strategy.avoid }}</p>
                            </div>
                            <div class="col-md-6">
                                <div class="alert alert-info">
                                    <h6><i class="fas fa-info-circle"></i> Strategy Notes:</h6>
                                    <p class="mb-0">{{ timeframe_strategy.description }}</p>
                                    <hr>
                                    <small><strong>Risk Level:</strong> {{ timeframe_strategy.risk_tolerance }}</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Charts Section -->
        <div class="row">
            <div class="col-12">
                <ul class="nav nav-tabs" id="chartTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="performance-tab" data-bs-toggle="tab" data-bs-target="#performance" type="button" role="tab">
                            <i class="fas fa-chart-line"></i> Performance Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risk-return-tab" data-bs-toggle="tab" data-bs-target="#risk-return" type="button" role="tab">
                            <i class="fas fa-scatter-chart"></i> Risk vs Return
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="category-tab" data-bs-toggle="tab" data-bs-target="#category" type="button" role="tab">
                            <i class="fas fa-layer-group"></i> Category Analysis
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="economic-tab" data-bs-toggle="tab" data-bs-target="#economic" type="button" role="tab">
                            <i class="fas fa-globe-americas"></i> Economic Conditions
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="recommendations-tab" data-bs-toggle="tab" data-bs-target="#recommendations" type="button" role="tab">
                            <i class="fas fa-star"></i> Recommendations
                        </button>
                    </li>
                </ul>

                <div class="tab-content" id="chartTabContent">
                    <div class="tab-pane fade show active" id="performance" role="tabpanel">
                        <div class="chart-container">
                            <h4>Fund Performance vs FDRXX Money Market Rate</h4>
                            {% if dashboard.charts.fund_performance %}
                                <img src="data:image/png;base64,{{ dashboard.charts.fund_performance }}" class="chart-img" alt="Fund Performance Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="risk-return" role="tabpanel">
                        <div class="chart-container">
                            <h4>Risk vs Return Profile by Category</h4>
                            {% if dashboard.charts.risk_return_scatter %}
                                <img src="data:image/png;base64,{{ dashboard.charts.risk_return_scatter }}" class="chart-img" alt="Risk Return Scatter Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="category" role="tabpanel">
                        <div class="chart-container">
                            <h4>Category-wise Analysis</h4>
                            {% if dashboard.charts.category_analysis %}
                                <img src="data:image/png;base64,{{ dashboard.charts.category_analysis }}" class="chart-img" alt="Category Analysis Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="economic" role="tabpanel">
                        <div class="chart-container">
                            <h4>Economic Conditions Overview</h4>
                            {% if dashboard.charts.economic_conditions %}
                                <img src="data:image/png;base64,{{ dashboard.charts.economic_conditions }}" class="chart-img" alt="Economic Conditions Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>

                    <div class="tab-pane fade" id="recommendations" role="tabpanel">
                        <div class="chart-container">
                            <h4>Recommendations Summary</h4>
                            {% if dashboard.charts.recommendations %}
                                <img src="data:image/png;base64,{{ dashboard.charts.recommendations }}" class="chart-img" alt="Recommendations Chart">
                            {% else %}
                                <p class="text-muted">Chart not available</p>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Detailed Fund Recommendations -->
        <div class="row mt-4">
            <!-- Good Funds -->
            <div class="col-md-4">
                <h4 class="text-success"><i class="fas fa-thumbs-up"></i> Top Recommendations</h4>
                {% for fund in dashboard.recommendations.good[:6] %}
                <div class="fund-card card good">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-info recommendation-badge">{{ fund.category }}</span>
                                {% if fund.cost_analysis %}
                                <br><span class="badge 
                                    {% if fund.cost_analysis.cost_tier == 'Fidelity ZERO' %}bg-success
                                    {% elif fund.cost_analysis.cost_tier == 'Fidelity Premium' %}bg-primary
                                    {% elif fund.cost_analysis.cost_tier == 'Commission-Free ETF' %}bg-info
                                    {% else %}bg-secondary{% endif %} mt-1">
                                    {{ fund.cost_analysis.cost_tier }}
                                </span>
                                {% endif %}
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-success">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Neutral Funds -->
            <div class="col-md-4">
                <h4 class="text-warning"><i class="fas fa-minus-circle"></i> Neutral Consideration</h4>
                {% for fund in dashboard.recommendations.neutral[:6] %}
                <div class="fund-card card neutral">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-warning recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-warning">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Bad Funds -->
            <div class="col-md-4">
                <h4 class="text-danger"><i class="fas fa-thumbs-down"></i> Avoid These</h4>
                {% for fund in dashboard.recommendations.bad[:6] %}
                <div class="fund-card card bad">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <h6 class="card-title">{{ fund.symbol }}</h6>
                                <p class="card-text small text-muted">{{ fund.name }}</p>
                                <span class="badge bg-danger recommendation-badge">{{ fund.category }}</span>
                            </div>
                            <div class="text-end">
                                {% if fund.risk_metrics %}
                                <div class="metric-value text-danger">{{ "%.1f"|format(fund.score) }}</div>
                                <div class="metric-label">Score</div>
                                {% endif %}
                            </div>
                        </div>
                        {% if fund.risk_metrics %}
                        <div class="row mt-2">
                            <div class="col-6">
                                <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">
                                    Vol vs S&P: 
                                    {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                        <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% else %}
                                        <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                    {% endif %}
                                </small>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-6">
                                <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                            </div>
                            <div class="col-6">
                                <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                            </div>
                        </div>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>

        <!-- Duplicate Funds Section (Collapsed by Default) -->
        {% if dashboard.recommendations.duplicates %}
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning bg-opacity-10" data-bs-toggle="collapse" data-bs-target="#duplicatesSection" aria-expanded="false" aria-controls="duplicatesSection" style="cursor: pointer;">
                        <h5 class="mb-0">
                            <i class="fas fa-copy"></i> Duplicate Funds Filtered Out 
                            <span class="badge bg-warning">{{ dashboard.recommendations.duplicates|length }}</span>
                            <small class="float-end"><i class="fas fa-chevron-down"></i> Click to expand</small>
                        </h5>
                    </div>
                    <div class="collapse" id="duplicatesSection">
                        <div class="card-body">
                            <p class="text-muted mb-3">
                                <i class="fas fa-info-circle"></i> These funds have significant overlap with higher-ranked funds and are filtered from main recommendations to avoid duplication.
                            </p>
                            <div class="row">
                                {% for fund in dashboard.recommendations.duplicates %}
                                <div class="col-md-4 mb-3">
                                    <div class="card border-warning fund-card">
                                        <div class="card-body">
                                            <div class="d-flex justify-content-between align-items-start">
                                                <div>
                                                    <h6 class="card-title">{{ fund.symbol }}</h6>
                                                    <p class="card-text small text-muted">{{ fund.name }}</p>
                                                    <span class="badge bg-warning recommendation-badge">{{ fund.category }}</span>
                                                    {% if fund.duplicate_of %}
                                                    <br><small class="text-warning mt-1">
                                                        <i class="fas fa-arrow-right"></i> Similar to {{ fund.duplicate_of }} 
                                                        ({{ "%.0f"|format(fund.overlap_score * 100) }}% overlap)
                                                    </small>
                                                    {% endif %}
                                                </div>
                                                <div class="text-end">
                                                    <div class="metric-value text-warning">{{ "%.1f"|format(fund.score) }}</div>
                                                    <div class="metric-label">Score</div>
                                                </div>
                                            </div>
                                            {% if fund.risk_metrics %}
                                            <div class="row mt-2">
                                                <div class="col-6">
                                                    <small class="text-muted">Return: {{ "%.1f"|format(fund.risk_metrics.annual_return) }}%</small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">
                                                        Vol vs S&P: 
                                                        {% if fund.risk_metrics.volatility_vs_sp500 > 0 %}
                                                            <span class="text-warning">+{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                                        {% else %}
                                                            <span class="text-success">{{ "%.1f"|format(fund.risk_metrics.volatility_vs_sp500) }}%</span>
                                                        {% endif %}
                                                    </small>
                                                </div>
                                            </div>
                                            <div class="row">
                                                <div class="col-6">
                                                    <small class="text-muted">Sharpe: {{ "%.2f"|format(fund.risk_metrics.sharpe_ratio) }}</small>
                                                </div>
                                                <div class="col-6">
                                                    <small class="text-muted">Excess: {{ "%.1f"|format(fund.risk_metrics.excess_return) }}%</small>
                                                </div>
                                            </div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endif %}

        <!-- Portfolio Allocation Recommendations -->
        <div class="row mt-5">
            <div class="col-12">
                <div class="card border-success">
                    <div class="card-header bg-success bg-opacity-10">
                        <h4 class="mb-0 text-success">
                            <i class="fas fa-pie-chart"></i> Multi-Year Portfolio Allocation Strategy
                        </h4>
                        <small class="text-muted">Optimal fund allocation percentages for your next 4 years of investing</small>
                    </div>
                    <div class="card-body">
                        <!-- Investment Amount Calculator -->
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="alert alert-primary">
                                    <div class="row align-items-center">
                                        <div class="col-md-4">
                                            <label for="investmentAmount" class="form-label mb-0">
                                                <strong><i class="fas fa-dollar-sign"></i> Investment Amount:</strong>
                                            </label>
                                        </div>
                                        <div class="col-md-4">
                                            <div class="input-group">
                                                <span class="input-group-text">$</span>
                                                <input type="number" class="form-control" id="investmentAmount" value="10000" min="100" max="10000000" step="100" onchange="updatePortfolioCalculations()">
                                            </div>
                                        </div>
                                        <div class="col-md-4">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle"></i> Enter your investment amount to see exact purchase amounts for each fund
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Recession Analysis Section -->
                        {% if dashboard.economic_data.enhanced_recession_risk %}
                        <div class="row mb-4">
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-chart-line"></i> Detailed Recession Risk Analysis
                                        </h5>
                                        <small class="text-muted">Economic metrics driving our portfolio allocation strategy</small>
                                    </div>
                                    <div class="card-body">
                                        <!-- Risk Score Summary -->
                                        <div class="row mb-4">
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.base_score <= 33 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.base_score <= 66 else 'bg-danger bg-opacity-10' }}">
                                                    <h6 class="mb-1">Base Recession Score</h6>
                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.base_score <= 33 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.base_score <= 66 else 'text-danger' }}">
                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.base_score) }}/100
                                                    </div>
                                                    <small class="text-muted">Traditional indicators</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.enhanced_score <= 33 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.enhanced_score <= 66 else 'bg-danger bg-opacity-10' }}">
                                                    <h6 class="mb-1">Enhanced Score</h6>
                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.enhanced_score <= 33 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.enhanced_score <= 66 else 'text-danger' }}">
                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.enhanced_score) }}/100
                                                    </div>
                                                    <small class="text-muted">With your key concerns</small>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 5 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 15 else 'bg-danger bg-opacity-10' }}">
                                                    <h6 class="mb-1">Additional Risk</h6>
                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 5 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 15 else 'text-danger' }}">
                                                        +{{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.additional_risk) }}
                                                    </div>
                                                    <small class="text-muted">Enhanced analysis</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Baseline 0-10 Scale -->
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="card border-primary">
                                                    <div class="card-header bg-primary bg-opacity-10">
                                                        <h6 class="mb-0 text-primary">
                                                            <i class="fas fa-tachometer-alt"></i> Baseline Alert Scale (0-10)
                                                        </h6>
                                                        <small class="text-muted">0 = Full Growth Mode | 10 = 5-Alarm Fire</small>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <div class="col-md-6">
                                                                <div class="text-center p-3 border rounded">
                                                                    <h6 class="mb-1">Traditional Risk Level</h6>
                                                                    <div class="h3 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.baseline_scale['base_score_10'] <= 3 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.baseline_scale['base_score_10'] <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.baseline_scale['base_score_10']) }}/10
                                                                    </div>
                                                                    <div class="small font-weight-bold">{{ dashboard.economic_data.enhanced_recession_risk.baseline_scale['base_label'] }}</div>
                                                                </div>
                                                            </div>
                                                            <div class="col-md-6">
                                                                <div class="text-center p-3 border rounded">
                                                                    <h6 class="mb-1">Enhanced Risk Level</h6>
                                                                    <div class="h3 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.baseline_scale['enhanced_score_10'] <= 3 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.baseline_scale['enhanced_score_10'] <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.baseline_scale['enhanced_score_10']) }}/10
                                                                    </div>
                                                                    <div class="small font-weight-bold">{{ dashboard.economic_data.enhanced_recession_risk.baseline_scale['enhanced_label'] }}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="mt-3">
                                                            <div class="progress" style="height: 25px;">
                                                                <div class="progress-bar bg-success" role="progressbar" style="width: 30%" aria-label="Growth Zone">
                                                                    <span class="text-dark font-weight-bold">Growth (0-3)</span>
                                                                </div>
                                                                <div class="progress-bar bg-warning" role="progressbar" style="width: 30%" aria-label="Caution Zone">
                                                                    <span class="text-dark font-weight-bold">Caution (3-6)</span>
                                                                </div>
                                                                <div class="progress-bar bg-danger" role="progressbar" style="width: 40%" aria-label="Crisis Zone">
                                                                    <span class="text-white font-weight-bold">Crisis (6-10)</span>
                                                                </div>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 5 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 15 else 'bg-danger bg-opacity-10' }}">
                                                    <h6 class="mb-1">Additional Risk</h6>
                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 5 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.additional_risk <= 15 else 'text-danger' }}">
                                                        +{{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.additional_risk) }}
                                                    </div>
                                                    <small class="text-muted">Enhanced analysis</small>
                                                </div>
                                            </div>
                                        </div>

                                        <!-- Component Baselines Section -->
                                        {% if dashboard.economic_data.enhanced_recession_risk.component_baselines %}
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="card border-info">
                                                    <div class="card-header bg-info bg-opacity-10">
                                                        <h6 class="mb-0 text-info">
                                                            <i class="fas fa-gauge"></i> Enhanced Analysis Component Baselines
                                                        </h6>
                                                        <small class="text-muted">Individual risk factors on 0-10 baseline scale</small>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            <!-- Employment Risk -->
                                                            <div class="col-md-4">
                                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['score'] <= 3 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['score'] <= 6 else 'bg-danger bg-opacity-10' }}">
                                                                    <h6 class="mb-1">Employment Risk</h6>
                                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['score'] <= 3 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['score'] <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['score']) }}/10
                                                                    </div>
                                                                    <div class="small fw-bold">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['risk_level'] }}</div>
                                                                    <div class="small text-muted mt-1">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['employment']['label'] }}</div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Investment Flows Risk -->
                                                            <div class="col-md-4">
                                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['score'] <= 3 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['score'] <= 6 else 'bg-danger bg-opacity-10' }}">
                                                                    <h6 class="mb-1">Investment Flows Risk</h6>
                                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['score'] <= 3 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['score'] <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['score']) }}/10
                                                                    </div>
                                                                    <div class="small fw-bold">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['risk_level'] }}</div>
                                                                    <div class="small text-muted mt-1">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['investment_flows']['label'] }}</div>
                                                                </div>
                                                            </div>
                                                            
                                                            <!-- Consumer Sentiment Risk -->
                                                            <div class="col-md-4">
                                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['score'] <= 3 else 'bg-warning bg-opacity-10' if dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['score'] <= 6 else 'bg-danger bg-opacity-10' }}">
                                                                    <h6 class="mb-1">Consumer Sentiment Risk</h6>
                                                                    <div class="h4 {{ 'text-success' if dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['score'] <= 3 else 'text-warning' if dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['score'] <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['score']) }}/10
                                                                    </div>
                                                                    <div class="small fw-bold">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['risk_level'] }}</div>
                                                                    <div class="small text-muted mt-1">{{ dashboard.economic_data.enhanced_recession_risk.component_baselines['consumer_sentiment']['label'] }}</div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <div class="mt-3">
                                                            <div class="alert alert-light">
                                                                <h6 class="mb-2"><i class="fas fa-info-circle text-info"></i> Component Baseline Scale Guide</h6>
                                                                <div class="row small">
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-success me-2">0-3</span><strong>Low Risk:</strong> Full Growth to Moderate Growth conditions
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-warning me-2">4-6</span><strong>Moderate Risk:</strong> Caution to High Risk conditions
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-danger me-2">7-10</span><strong>High Risk:</strong> Very High Risk to 5-Alarm Fire conditions
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Enhanced Explanations -->
                                                        {% if dashboard.economic_data.enhanced_recession_risk.enhanced_explanations %}
                                                        <div class="mt-4">
                                                            <h6 class="text-info mb-3"><i class="fas fa-microscope"></i> Enhanced Indicator Deep Dive</h6>
                                                            <div class="accordion" id="enhancedExplanationsAccordion">
                                                                {% for component_name, explanation in dashboard.economic_data.enhanced_recession_risk.enhanced_explanations.items() %}
                                                                <div class="accordion-item mb-2">
                                                                    <h2 class="accordion-header" id="headingEnhanced{{ component_name }}">
                                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseEnhanced{{ component_name }}" aria-expanded="false" aria-controls="collapseEnhanced{{ component_name }}">
                                                                            <div class="d-flex align-items-center w-100">
                                                                                <div class="me-3">
                                                                                    {% set component_data = dashboard.economic_data.enhanced_recession_risk.component_baselines[component_name] %}
                                                                                    <span class="badge {{ 'bg-success' if component_data.score <= 3 else 'bg-warning' if component_data.score <= 6 else 'bg-danger' }}">
                                                                                        {{ "%.1f"|format(component_data.score) }}/10
                                                                                    </span>
                                                                                </div>
                                                                                <div class="flex-grow-1">
                                                                                    <strong>
                                                                                        {% if component_name == 'employment' %}
                                                                                            Employment Trends Analysis
                                                                                        {% elif component_name == 'investment_flows' %}
                                                                                            Investment Flows Analysis
                                                                                        {% elif component_name == 'consumer_sentiment' %}
                                                                                            Consumer Sentiment Analysis
                                                                                        {% else %}
                                                                                            {{ component_name.title().replace('_', ' ') }}
                                                                                        {% endif %}
                                                                                    </strong>
                                                                                    <div class="small text-muted">{{ component_data.risk_level }} Risk - {{ component_data.label }}</div>
                                                                                </div>
                                                                            </div>
                                                                        </button>
                                                                    </h2>
                                                                    <div id="collapseEnhanced{{ component_name }}" class="accordion-collapse collapse show" aria-labelledby="headingEnhanced{{ component_name }}" data-bs-parent="#enhancedExplanationsAccordion">
                                                                        <div class="accordion-body">
                                                                            <div class="alert alert-light">
                                                                                <div class="small">{{ explanation }}</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Economic Indicator Baselines Section -->
                                        {% if dashboard.economic_data.enhanced_recession_risk.indicator_baselines %}
                                        <div class="row mb-4">
                                            <div class="col-12">
                                                <div class="card border-primary">
                                                    <div class="card-header bg-primary bg-opacity-10">
                                                        <h6 class="mb-0 text-primary">
                                                            <i class="fas fa-chart-line"></i> Economic Indicator Baselines
                                                        </h6>
                                                        <small class="text-muted">All 11 key recession indicators on 0-10 baseline scale</small>
                                                    </div>
                                                    <div class="card-body">
                                                        <div class="row">
                                                            {% for indicator_name, indicator_data in dashboard.economic_data.enhanced_recession_risk.indicator_baselines.items() %}
                                                            <div class="col-md-4 col-lg-3 mb-3">
                                                                <div class="text-center p-3 border rounded {{ 'bg-success bg-opacity-10' if indicator_data.score <= 3 else 'bg-warning bg-opacity-10' if indicator_data.score <= 6 else 'bg-danger bg-opacity-10' }}">
                                                                    <h6 class="mb-1 small">
                                                                        {% if indicator_name == 'sahm_rule' %}
                                                                            Sahm Rule
                                                                        {% elif indicator_name == 'yield_curve' %}
                                                                            10Y-3M Spread
                                                                        {% elif indicator_name == 'labor_market' %}
                                                                            Labor Market
                                                                        {% elif indicator_name == 'lei_index' %}
                                                                            LEI Index
                                                                        {% elif indicator_name == 'pmi' %}
                                                                            PMI
                                                                        {% elif indicator_name == 'gdp_growth' %}
                                                                            GDP Growth
                                                                        {% elif indicator_name == 'sp500_ma200' %}
                                                                            S&P vs MA200
                                                                        {% elif indicator_name == 'fear_greed' %}
                                                                            Fear & Greed
                                                                        {% elif indicator_name == 'vix' %}
                                                                            VIX Level
                                                                        {% elif indicator_name == 'credit_spreads' %}
                                                                            Credit Spreads
                                                                        {% elif indicator_name == 'core_pce' %}
                                                                            Core PCE
                                                                        {% else %}
                                                                            {{ indicator_name.title().replace('_', ' ') }}
                                                                        {% endif %}
                                                                    </h6>
                                                                    <div class="h5 mb-1 {{ 'text-success' if indicator_data.score <= 3 else 'text-warning' if indicator_data.score <= 6 else 'text-danger' }}">
                                                                        {{ "%.1f"|format(indicator_data.score) }}/10
                                                                    </div>
                                                                    <div class="small fw-bold">{{ indicator_data.risk_level }}</div>
                                                                    <div class="small text-muted mt-1">
                                                                        {% if indicator_name in ['yield_curve', 'gdp_growth', 'sp500_ma200'] %}
                                                                            {{ "%.1f"|format(indicator_data.value) }}%
                                                                        {% elif indicator_name in ['sahm_rule', 'lei_index', 'credit_spreads', 'core_pce'] %}
                                                                            {{ "%.1f"|format(indicator_data.value) }}%
                                                                        {% elif indicator_name == 'labor_market' %}
                                                                            {{ "{:,}".format(indicator_data.value|int) }}
                                                                        {% else %}
                                                                            {{ "%.1f"|format(indicator_data.value) }}
                                                                        {% endif %}
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            {% endfor %}
                                                        </div>
                                                        
                                                        <div class="mt-3">
                                                            <div class="alert alert-light">
                                                                <h6 class="mb-2"><i class="fas fa-info-circle text-primary"></i> Economic Indicator Baseline Scale Guide</h6>
                                                                <div class="row small">
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-success me-2">0-3</span><strong>Low Risk:</strong> Conditions favorable for growth assets
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-warning me-2">4-6</span><strong>Moderate Risk:</strong> Mixed signals requiring caution
                                                                    </div>
                                                                    <div class="col-md-4">
                                                                        <span class="badge bg-danger me-2">7-10</span><strong>High Risk:</strong> Recession warning signals
                                                                    </div>
                                                                </div>
                                                                <div class="mt-2 small text-muted">
                                                                    Each indicator is scored based on historical recession probability thresholds.
                                                                </div>
                                                            </div>
                                                        </div>
                                                        
                                                        <!-- Detailed Indicator Explanations -->
                                                        {% if dashboard.economic_data.enhanced_recession_risk.indicator_explanations %}
                                                        <div class="mt-4">
                                                            <h6 class="text-primary mb-3"><i class="fas fa-info-circle"></i> Detailed Indicator Analysis</h6>
                                                            <div class="accordion" id="indicatorExplanationsAccordion">
                                                                {% for indicator_name, explanation in dashboard.economic_data.enhanced_recession_risk.indicator_explanations.items() %}
                                                                <div class="accordion-item mb-2">
                                                                    <h2 class="accordion-header" id="heading{{ indicator_name }}">
                                                                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapse{{ indicator_name }}" aria-expanded="false" aria-controls="collapse{{ indicator_name }}">
                                                                            <div class="d-flex align-items-center w-100">
                                                                                <div class="me-3">
                                                                                    {% set indicator_data = dashboard.economic_data.enhanced_recession_risk.indicator_baselines[indicator_name] %}
                                                                                    <span class="badge {{ 'bg-success' if indicator_data.score <= 3 else 'bg-warning' if indicator_data.score <= 6 else 'bg-danger' }}">
                                                                                        {{ "%.1f"|format(indicator_data.score) }}/10
                                                                                    </span>
                                                                                </div>
                                                                                <div class="flex-grow-1">
                                                                                    <strong>
                                                                                        {% if indicator_name == 'sahm_rule' %}
                                                                                            Sahm Rule
                                                                                        {% elif indicator_name == 'yield_curve' %}
                                                                                            10Y-3M Treasury Spread
                                                                                        {% elif indicator_name == 'labor_market' %}
                                                                                            Enhanced Labor Market
                                                                                        {% elif indicator_name == 'lei_index' %}
                                                                                            Leading Economic Index (LEI)
                                                                                        {% elif indicator_name == 'pmi' %}
                                                                                            Purchasing Managers Index (PMI)
                                                                                        {% elif indicator_name == 'gdp_growth' %}
                                                                                            GDP Growth Rate
                                                                                        {% elif indicator_name == 'sp500_ma200' %}
                                                                                            S&P 500 vs 200-Day MA
                                                                                        {% elif indicator_name == 'fear_greed' %}
                                                                                            CNN Fear & Greed Index
                                                                                        {% elif indicator_name == 'vix' %}
                                                                                            VIX Volatility Index
                                                                                        {% elif indicator_name == 'credit_spreads' %}
                                                                                            Investment Grade Credit Spreads
                                                                                        {% elif indicator_name == 'core_pce' %}
                                                                                            Core PCE Inflation
                                                                                        {% else %}
                                                                                            {{ indicator_name.title().replace('_', ' ') }}
                                                                                        {% endif %}
                                                                                    </strong>
                                                                                    <div class="small text-muted">{{ indicator_data.risk_level }} Risk - Current Value: 
                                                                                        {% if indicator_name in ['yield_curve', 'gdp_growth', 'sp500_ma200'] %}
                                                                                            {{ "%.1f"|format(indicator_data.value) }}%
                                                                                        {% elif indicator_name in ['sahm_rule', 'lei_index', 'credit_spreads', 'core_pce'] %}
                                                                                            {{ "%.1f"|format(indicator_data.value) }}%
                                                                                        {% elif indicator_name == 'labor_market' %}
                                                                                            {{ "{:,}".format(indicator_data.value|int) }}
                                                                                        {% else %}
                                                                                            {{ "%.1f"|format(indicator_data.value) }}
                                                                                        {% endif %}
                                                                                    </div>
                                                                                </div>
                                                                            </div>
                                                                        </button>
                                                                    </h2>
                                                                    <div id="collapse{{ indicator_name }}" class="accordion-collapse collapse show" aria-labelledby="heading{{ indicator_name }}" data-bs-parent="#indicatorExplanationsAccordion">
                                                                        <div class="accordion-body">
                                                                            <div class="alert alert-light">
                                                                                <div class="small">{{ explanation }}</div>
                                                                            </div>
                                                                        </div>
                                                                    </div>
                                                                </div>
                                                                {% endfor %}
                                                            </div>
                                                        </div>
                                                        {% endif %}
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        {% endif %}

                                        <!-- Economic Metrics Breakdown -->
                                        <div class="accordion" id="recessionAnalysisAccordion">
                                            <div class="accordion-item">
                                                <h2 class="accordion-header" id="headingMetrics">
                                                    <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseMetrics" aria-expanded="true" aria-controls="collapseMetrics">
                                                        <i class="fas fa-chart-bar me-2"></i>
                                                        <strong>Economic Indicators Breakdown</strong>
                                                        <span class="ms-auto me-3 text-muted small">Click to expand detailed analysis</span>
                                                    </button>
                                                </h2>
                                                <div id="collapseMetrics" class="accordion-collapse collapse show" aria-labelledby="headingMetrics" data-bs-parent="#recessionAnalysisAccordion">
                                                    <div class="accordion-body">
                                                        <div class="row">
                                                            <!-- Traditional Economic Indicators -->
                                                            <div class="col-md-6">
                                                                <h6 class="text-primary mb-3"><i class="fas fa-university"></i> Traditional Economic Indicators</h6>
                                                                
                                                                <!-- Yield Curve -->
                                                                <div class="metric-card mb-3 p-3 border rounded">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>10Y-3M Yield Spread</strong>
                                                                            <div class="small text-muted">10-Year Treasury minus 3-Month Treasury</div>
                                                                        </div>
                                                                        <span class="badge bg-danger">High Risk</span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What it measures:</strong> When short-term rates exceed long-term rates (inverted yield curve), it historically predicts recessions within 6-18 months.</div>
                                                                        <div class="small mt-1"><strong>Weight in model:</strong> 12.32% - One of our strongest recession predictors</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Inverted curves push us toward more defensive bonds and away from growth stocks</div>
                                                                    </div>
                                                                </div>

                                                                <!-- Sahm Rule -->
                                                                <div class="metric-card mb-3 p-3 border rounded">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>Enhanced Sahm Rule</strong>
                                                                            <div class="small text-muted">Unemployment rate trend analysis</div>
                                                                        </div>
                                                                        <span class="badge bg-warning">Moderate</span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What it measures:</strong> When unemployment rises 0.5% above its recent low, a recession has likely begun. We enhance this with job openings and consumer spending data.</div>
                                                                        <div class="small mt-1"><strong>Weight in model:</strong> 6.14% - Real-time recession confirmation</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Rising unemployment signals shift to defensive assets and government bonds</div>
                                                                    </div>
                                                                </div>

                                                                <!-- PMI -->
                                                                <div class="metric-card mb-3 p-3 border rounded">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>PMI (Purchasing Managers' Index)</strong>
                                                                            <div class="small text-muted">Manufacturing sector activity</div>
                                                                        </div>
                                                                        <span class="badge bg-warning">Below 50</span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What it measures:</strong> Surveys manufacturing purchasing managers. Below 50 = contraction, above 50 = expansion. We estimate using industrial production when direct data unavailable.</div>
                                                                        <div class="small mt-1"><strong>Weight in model:</strong> 5.34% - Leading indicator of economic activity</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Manufacturing weakness reduces exposure to industrial and small-cap stocks</div>
                                                                    </div>
                                                                </div>

                                                                <!-- LEI -->
                                                                <div class="metric-card mb-3 p-3 border rounded">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>LEI (Leading Economic Index)</strong>
                                                                            <div class="small text-muted">Composite of forward-looking indicators</div>
                                                                        </div>
                                                                        <span class="badge bg-warning">Declining</span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What it measures:</strong> Combines 10 indicators like building permits, stock prices, and interest rate spreads to predict economic direction 3-6 months ahead.</div>
                                                                        <div class="small mt-1"><strong>Weight in model:</strong> 3.46% - Forward-looking economic health</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Declining LEI reduces growth stock allocation and increases defensive positioning</div>
                                                                    </div>
                                                                </div>
                                                            </div>

                                                            <!-- Enhanced Analysis Factors -->
                                                            <div class="col-md-6">
                                                                <h6 class="text-success mb-3"><i class="fas fa-chart-line"></i> Enhanced Analysis (Your Key Concerns)</h6>
                                                                
                                                                <!-- White-Collar Employment -->
                                                                <div class="metric-card mb-3 p-3 border rounded bg-light">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>White-Collar Employment Trends</strong>
                                                                            <div class="small text-muted">Tech, finance, and media sector layoffs</div>
                                                                        </div>
                                                                        <span class="badge bg-{{ 'danger' if dashboard.economic_data.enhanced_recession_risk.employment_adjustment >= 15 else 'warning' if dashboard.economic_data.enhanced_recession_risk.employment_adjustment >= 8 else 'success' }}">
                                                                            +{{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.employment_adjustment) }} pts
                                                                        </span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What we monitor:</strong> Layoff announcements in high-paying sectors, JOLTS (Job Openings and Labor Turnover Survey) data showing hiring freezes, and unemployment claims trends.</div>
                                                                        <div class="small mt-1"><strong>Why it matters:</strong> White-collar workers drive consumer spending. Early layoffs in tech/finance often predict broader economic weakness before it shows in traditional data.</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> High risk reduces technology and growth stock allocation, increases defensive positioning</div>
                                                                    </div>
                                                                </div>

                                                                <!-- Investment Flows -->
                                                                <div class="metric-card mb-3 p-3 border rounded bg-light">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>401(k)/IRA Investment Flows</strong>
                                                                            <div class="small text-muted">Retirement account behavior analysis</div>
                                                                        </div>
                                                                        <span class="badge bg-{{ 'danger' if dashboard.economic_data.enhanced_recession_risk.flow_adjustment >= 10 else 'warning' if dashboard.economic_data.enhanced_recession_risk.flow_adjustment >= 5 else 'success' }}">
                                                                            +{{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.flow_adjustment) }} pts
                                                                        </span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What we monitor:</strong> Fidelity, Vanguard, and other major providers' flow data showing whether investors are moving toward stocks (risk-on) or bonds/cash (risk-off).</div>
                                                                        <div class="small mt-1"><strong>Why it matters:</strong> Retirement savers represent long-term smart money. When they get defensive, it often signals deeper economic concerns not yet reflected in prices.</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Defensive flows trigger reduced equity exposure and increased fixed income allocation</div>
                                                                    </div>
                                                                </div>

                                                                <!-- Consumer Sentiment -->
                                                                <div class="metric-card mb-3 p-3 border rounded bg-light">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>Retail Brokerage & Consumer Activity</strong>
                                                                            <div class="small text-muted">Robinhood, Schwab trading patterns & spending</div>
                                                                        </div>
                                                                        <span class="badge bg-{{ 'danger' if dashboard.economic_data.enhanced_recession_risk.consumer_adjustment >= 10 else 'warning' if dashboard.economic_data.enhanced_recession_risk.consumer_adjustment >= 5 else 'success' }}">
                                                                            +{{ "%.1f"|format(dashboard.economic_data.enhanced_recession_risk.consumer_adjustment) }} pts
                                                                        </span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What we monitor:</strong> Retail trading volumes, consumer sentiment surveys, credit card spending patterns, and retail brokerage account activity.</div>
                                                                        <div class="small mt-1"><strong>Why it matters:</strong> Consumer spending is 70% of GDP. When consumers pull back on both spending and investing, it signals economic trouble ahead.</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> Weak consumer activity reduces consumer discretionary and retail exposure, increases defensive sectors</div>
                                                                    </div>
                                                                </div>

                                                                <!-- Market Sentiment Indicators -->
                                                                <div class="metric-card mb-3 p-3 border rounded">
                                                                    <div class="d-flex justify-content-between align-items-start">
                                                                        <div>
                                                                            <strong>VIX & Fear/Greed Index</strong>
                                                                            <div class="small text-muted">Market volatility and sentiment</div>
                                                                        </div>
                                                                        <span class="badge bg-info">Market Timing</span>
                                                                    </div>
                                                                    <div class="mt-2">
                                                                        <div class="small"><strong>What it measures:</strong> VIX shows market fear (volatility expectations), F&G Index combines 7 market indicators to gauge overall sentiment.</div>
                                                                        <div class="small mt-1"><strong>Weight in model:</strong> VIX: 0.57%, F&G: 3.61% - Shorter-term market timing</div>
                                                                        <div class="small mt-1"><strong>Investment impact:</strong> High fear increases defensive positioning, extreme greed may signal market tops</div>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        </div>

                                                        <!-- How It Affects Your Portfolio -->
                                                        <div class="alert alert-info mt-4">
                                                            <h6><i class="fas fa-portfolio"></i> How This Analysis Affects Your Portfolio Strategy</h6>
                                                            <div class="row">
                                                                <div class="col-md-4">
                                                                    <strong>üü¢ Low Risk (0-33):</strong> Growth-focused allocation with higher equity exposure, minimal bonds
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <strong>üü° Moderate Risk (34-66):</strong> Balanced approach with increased defensive positioning and bond allocation
                                                                </div>
                                                                <div class="col-md-4">
                                                                    <strong>üî¥ High Risk (67-100):</strong> Defensive strategy emphasizing capital preservation, government bonds, and cash
                                                                </div>
                                                            </div>
                                                            <hr>
                                                            <div class="small">
                                                                <strong>Current Strategy Impact:</strong> 
                                                                {% if dashboard.economic_data.enhanced_recession_risk.additional_risk > 15 %}
                                                                Your enhanced analysis detected significant additional risk (+{{ "%.0f"|format(dashboard.economic_data.enhanced_recession_risk.additional_risk) }} points), triggering more defensive positioning across all timeframes.
                                                                {% elif dashboard.economic_data.enhanced_recession_risk.additional_risk > 8 %}
                                                                Moderate additional risk detected (+{{ "%.0f"|format(dashboard.economic_data.enhanced_recession_risk.additional_risk) }} points), resulting in slightly more conservative allocations.
                                                                {% else %}
                                                                Enhanced analysis shows minimal additional risk (+{{ "%.0f"|format(dashboard.economic_data.enhanced_recession_risk.additional_risk) }} points), maintaining standard allocation approach.
                                                                {% endif %}
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="row">
                            {% for key, allocation in portfolio_allocations.items() %}
                            <div class="col-md-3 mb-4">
                                <div class="card h-100 border-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}">
                                    <div class="card-header bg-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }} bg-opacity-10">
                                        <h6 class="mb-0 text-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}">
                                            <i class="fas fa-calendar-alt"></i> {{ allocation.timeframe }} Year{{ 's' if allocation.timeframe > 1 else '' }}
                                        </h6>
                                        <small class="text-muted">{{ allocation.strategy }} | {{ allocation.risk_level }} Risk</small>
                                    </div>
                                    <div class="card-body p-3">
                                        <p class="small text-muted mb-3">{{ allocation.description }}</p>
                                        
                                        <!-- Purchase Instructions -->
                                        <div class="alert alert-light mb-3 purchase-instructions" data-timeframe="{{ allocation.timeframe }}">
                                            <h6 class="mb-2"><i class="fas fa-shopping-cart"></i> Purchase Plan</h6>
                                            <div class="purchase-list">
                                                <!-- Will be populated by JavaScript -->
                                            </div>
                                            <div class="border-top pt-2 mt-2">
                                                <small class="text-muted">
                                                    <strong>Total Investment:</strong> <span class="total-amount">$10,000</span>
                                                </small>
                                            </div>
                                        </div>
                                        
                                        <!-- Allocation Chart -->
                                        <div class="allocation-chart mb-3">
                                            {% for fund_alloc in allocation.funds %}
                                            <div class="d-flex justify-content-between align-items-center mb-2 fund-allocation" 
                                                 data-timeframe="{{ allocation.timeframe }}" 
                                                 data-symbol="{{ fund_alloc.fund.symbol }}" 
                                                 data-allocation="{{ fund_alloc.allocation }}"
                                                 data-category="{{ fund_alloc.category }}">
                                                <div class="flex-grow-1">
                                                    <strong class="small">{{ fund_alloc.fund.symbol }}</strong>
                                                    <div class="small text-muted">{{ fund_alloc.category }}</div>
                                                </div>
                                                <div class="text-end">
                                                    <span class="badge bg-secondary">{{ "%.0f"|format(fund_alloc.allocation) }}%</span>
                                                </div>
                                            </div>
                                            <!-- Progress Bar -->
                                            <div class="progress mb-2" style="height: 6px;">
                                                <div class="progress-bar bg-{{ 'primary' if allocation.timeframe == 1 else 'info' if allocation.timeframe == 2 else 'warning' if allocation.timeframe == 3 else 'danger' }}" 
                                                     style="width: {{ fund_alloc.allocation }}%"></div>
                                            </div>
                                            {% endfor %}
                                        </div>
                                        
                                        <!-- Summary -->
                                        <div class="border-top pt-2">
                                            <small class="text-muted">
                                                <strong>Total Allocated:</strong> {{ "%.0f"|format(allocation.total_allocation) }}%<br>
                                                <strong>Funds Used:</strong> {{ allocation.funds|length }}
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endfor %}
                        </div>
                        
                        <!-- Master Purchase List - Consolidated across all years -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="card border-warning">
                                    <div class="card-header bg-warning bg-opacity-10">
                                        <h5 class="mb-0 text-warning">
                                            <i class="fas fa-calculator"></i> Master Purchase List - Total Allocation Across All 4 Years
                                        </h5>
                                        <small class="text-muted">Consolidated fund purchases needed to implement all timeframe strategies</small>
                                    </div>
                                    <div class="card-body">
                                        <div class="row">
                                            <div class="col-md-8">
                                                <div id="masterPurchaseList">
                                                    <!-- Will be populated by JavaScript -->
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <div class="card bg-light">
                                                    <div class="card-body">
                                                        <h6 class="card-title">
                                                            <i class="fas fa-shopping-cart"></i> Total Investment Summary
                                                        </h6>
                                                        <hr>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 1:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear1">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 2:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear2">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 3:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear3">$10,000</div>
                                                        </div>
                                                        <div class="row mb-2">
                                                            <div class="col-6"><strong>Year 4:</strong></div>
                                                            <div class="col-6 text-end" id="totalYear4">$10,000</div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-6"><strong>Grand Total:</strong></div>
                                                            <div class="col-6 text-end"><strong id="grandTotal">$40,000</strong></div>
                                                        </div>
                                                        <hr>
                                                        <div class="row">
                                                            <div class="col-6"><strong>Unique Funds:</strong></div>
                                                            <div class="col-6 text-end" id="uniqueFundCount">-</div>
                                                        </div>
                                                        
                                                        <button class="btn btn-warning w-100 mt-3" onclick="copyMasterPurchaseList()">
                                                            <i class="fas fa-copy"></i> Copy Master List
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Portfolio Strategy Summary -->
                        <div class="row mt-4">
                            <div class="col-12">
                                <div class="alert alert-light">
                                    <h6><i class="fas fa-lightbulb"></i> Portfolio Strategy Guidelines</h6>
                                    <div class="row">
                                        <div class="col-md-3">
                                            <strong>üìÖ 1 Year:</strong> Capital preservation focus with bonds and stable funds for near-term goals.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 2 Years:</strong> Conservative growth balancing stability with modest equity exposure.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 3 Years:</strong> Balanced approach with diversified equity and bond mix for medium-term growth.
                                        </div>
                                        <div class="col-md-3">
                                            <strong>üìÖ 4 Years:</strong> Growth-focused portfolio with higher equity allocation for long-term appreciation.
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="row mt-4 mb-4">
            <div class="col-12">
                <div class="card bg-light">
                    <div class="card-body">
                        <h5><i class="fas fa-info-circle"></i> Analysis Summary</h5>
                        <p><strong>Methodology:</strong> This dashboard analyzes Fidelity and Vanguard index funds based on risk-adjusted returns, economic conditions, and current market environment. Funds are scored considering excess returns over FDRXX money market rates, volatility, Sharpe ratios, and adjustments for recession risk, inflation, and dollar strength. <strong>Fund scores are enhanced for Fidelity account holders, giving preference to Fidelity ZERO funds (0.00% expense ratio) and other cost advantages.</strong> <strong>Duplicate funds with significant overlap are automatically filtered out to prevent redundant investments.</strong></p>
                        
                        <p><strong>Current Environment:</strong> 
                            Recession Risk: {{ dashboard.economic_data.recession_level }} | 
                            Inflation Risk: {{ dashboard.economic_data.inflation_risk }} | 
                            Dollar: {{ dashboard.economic_data.dollar_strength }} | 
                            Volatility: {{ dashboard.economic_data.market_volatility }}
                        </p>
                        
                        <p><strong>Baseline:</strong> FDRXX money market rate of {{ "%.2f"|format(dashboard.money_market_rate) }}% used as risk-free return benchmark.</p>
                        
                        <p class="text-muted mb-0"><small>Last updated: <span id="current-time"></span> | Data sources: Yahoo Finance, FRED Economic Data</small></p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment.min.js"></script>
    <script>
        // Auto-refresh every 5 minutes during market hours
        const refreshInterval = 5 * 60 * 1000; // 5 minutes
        
        function isMarketHours() {
            const now = moment();
            const hour = now.hour();
            const day = now.day();
            
            // Simple check for US market hours (9:30 AM - 4:00 PM ET, Mon-Fri)
            return day >= 1 && day <= 5 && hour >= 9 && hour <= 16;
        }
        
        if (isMarketHours()) {
            setInterval(() => {
                location.reload();
            }, refreshInterval);
        }
        
        // Add tooltips for better UX
        document.addEventListener('DOMContentLoaded', function() {
            // Set current time
            const currentTime = moment().format('MMMM Do YYYY, h:mm:ss a');
            document.getElementById('current-time').textContent = currentTime;
            
            // Initialize tooltips if needed
            console.log('Fidelity Dashboard loaded');
        });
        
        // Timeframe update function
        function updateTimeframe() {
            const timeframe = document.getElementById('timeframe').value;
            const refreshBtn = document.querySelector('button[onclick="updateTimeframe()"]');
            
            // Show loading indicator
            if (refreshBtn) {
                refreshBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
                refreshBtn.disabled = true;
            }
            
            // Add a small delay to show loading indicator
            setTimeout(() => {
                window.location.href = `/?timeframe=${timeframe}`;
            }, 200);
        }
        
        // Add visual feedback when dropdown changes
        document.addEventListener('DOMContentLoaded', function() {
            const timeframeSelect = document.getElementById('timeframe');
            if (timeframeSelect) {
                timeframeSelect.addEventListener('change', function() {
                    this.style.backgroundColor = '#e3f2fd';
                    setTimeout(() => {
                        this.style.backgroundColor = '';
                    }, 300);
                });
            }
        });
        
        // Portfolio calculation functions
        function updatePortfolioCalculations() {
            const investmentAmount = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            
            // Update all portfolio calculations
            const instructions = document.querySelectorAll('.purchase-instructions');
            instructions.forEach(instruction => {
                const timeframe = instruction.getAttribute('data-timeframe');
                updateTimeframeCalculation(timeframe, investmentAmount);
            });
            
            // Update master purchase list
            updateMasterPurchaseList(investmentAmount);
        }
        
        function updateTimeframeCalculation(timeframe, totalAmount) {
            const instructionDiv = document.querySelector(`[data-timeframe="${timeframe}"] .purchase-list`);
            const totalAmountSpan = document.querySelector(`[data-timeframe="${timeframe}"] .total-amount`);
            
            if (!instructionDiv) return;
            
            // Get all fund allocations for this timeframe
            const fundAllocations = document.querySelectorAll(`[data-timeframe="${timeframe}"].fund-allocation`);
            
            let purchaseHtml = '';
            let runningTotal = 0;
            
            // Track funds seen to prevent duplicates within the same timeframe
            const fundsSeenThisTimeframe = new Set();
            
            fundAllocations.forEach(allocation => {
                const symbol = allocation.getAttribute('data-symbol');
                const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                const category = allocation.getAttribute('data-category');
                const amount = Math.round(totalAmount * (percentage / 100));
                
                // Check for duplicates within the same timeframe
                if (fundsSeenThisTimeframe.has(symbol)) {
                    console.warn(`Timeframe ${timeframe}: DUPLICATE FUND DETECTED: ${symbol} - skipping duplicate entry`);
                    return; // Skip this duplicate entry
                }
                fundsSeenThisTimeframe.add(symbol);
                
                runningTotal += amount;
                
                purchaseHtml += `
                    <div class="d-flex justify-content-between align-items-center mb-1">
                        <div>
                            <strong class="small">${symbol}</strong>
                            <span class="text-muted small">(${percentage.toFixed(0)}%)</span>
                        </div>
                        <div class="text-end">
                            <strong class="text-success">$${amount.toLocaleString()}</strong>
                        </div>
                    </div>
                `;
            });
            
            // Add any remaining amount to the largest allocation if there's a rounding difference
            const difference = totalAmount - runningTotal;
            if (Math.abs(difference) > 0) {
                purchaseHtml += `
                    <div class="text-muted small mt-1">
                        ${difference > 0 ? `Remaining: $${difference}` : `Over by: $${Math.abs(difference)}`}
                    </div>
                `;
            }
            
            instructionDiv.innerHTML = purchaseHtml;
            
            if (totalAmountSpan) {
                totalAmountSpan.textContent = `$${totalAmount.toLocaleString()}`;
            }
        }
        
        // Initialize portfolio calculations on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing portfolio calculations...');
            
            // Small delay to ensure all elements are properly rendered
            setTimeout(() => {
                updatePortfolioCalculations();
                console.log('Portfolio calculations updated');
            }, 100);
            
            // Add copy-to-clipboard functionality for purchase instructions
            const purchaseInstructions = document.querySelectorAll('.purchase-instructions');
            purchaseInstructions.forEach(instruction => {
                const timeframe = instruction.getAttribute('data-timeframe');
                const copyBtn = document.createElement('button');
                copyBtn.className = 'btn btn-sm btn-outline-secondary mt-2';
                copyBtn.innerHTML = '<i class="fas fa-copy"></i> Copy Purchase List';
                copyBtn.onclick = () => copyPurchaseList(timeframe);
                instruction.appendChild(copyBtn);
            });
        });
        
        function copyPurchaseList(timeframe) {
            const instructionDiv = document.querySelector(`[data-timeframe="${timeframe}"] .purchase-list`);
            const totalAmountSpan = document.querySelector(`[data-timeframe="${timeframe}"] .total-amount`);
            
            if (!instructionDiv) return;
            
            // Create text version of purchase list
            const fundAllocations = document.querySelectorAll(`[data-timeframe="${timeframe}"].fund-allocation`);
            const totalAmount = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            
            let copyText = `${timeframe} Year Portfolio Allocation (${totalAmountSpan.textContent}):\n\n`;
            
            // Track funds seen to prevent duplicates within the same timeframe
            const fundsSeenThisTimeframe = new Set();
            
            fundAllocations.forEach(allocation => {
                const symbol = allocation.getAttribute('data-symbol');
                const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                const amount = Math.round(totalAmount * (percentage / 100));
                
                // Check for duplicates within the same timeframe
                if (fundsSeenThisTimeframe.has(symbol)) {
                    console.warn(`Copy - Timeframe ${timeframe}: DUPLICATE FUND DETECTED: ${symbol} - skipping duplicate entry`);
                    return; // Skip this duplicate entry
                }
                fundsSeenThisTimeframe.add(symbol);
                
                copyText += `${symbol}: $${amount.toLocaleString()} (${percentage.toFixed(0)}%)\n`;
            });
            
            // Copy to clipboard
            navigator.clipboard.writeText(copyText).then(() => {
                // Show success feedback
                const btn = event.target.closest('button');
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
                btn.className = 'btn btn-sm btn-success mt-2';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-sm btn-outline-secondary mt-2';
                }, 2000);
            }).catch(err => {
                console.error('Failed to copy: ', err);
            });
        }
        
        function updateMasterPurchaseList(totalAmountPerYear) {
            console.log('Starting updateMasterPurchaseList with amount:', totalAmountPerYear);
            
            // Collect all fund allocations across all timeframes
            const masterFunds = {};
            const yearTotals = {};
            
            // Process each timeframe (1-4 years)
            for (let year = 1; year <= 4; year++) {
                const fundAllocations = document.querySelectorAll(`[data-timeframe="${year}"].fund-allocation`);
                console.log(`Year ${year}: Found ${fundAllocations.length} fund allocations`);
                yearTotals[year] = totalAmountPerYear;
                
                // Track funds seen in this year to prevent duplicates within the same year
                const fundsSeenThisYear = new Set();
                
                fundAllocations.forEach(allocation => {
                    const symbol = allocation.getAttribute('data-symbol');
                    const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                    const category = allocation.getAttribute('data-category');
                    const amount = Math.round(totalAmountPerYear * (percentage / 100));
                    
                    // Check for duplicates within the same year
                    if (fundsSeenThisYear.has(symbol)) {
                        console.warn(`  Year ${year}: DUPLICATE FUND DETECTED: ${symbol} - skipping duplicate entry`);
                        return; // Skip this duplicate entry
                    }
                    fundsSeenThisYear.add(symbol);
                    
                    console.log(`  Year ${year}: ${symbol} - ${percentage}% = $${amount.toLocaleString()}`);
                    
                    if (!masterFunds[symbol]) {
                        masterFunds[symbol] = {
                            category: category,
                            totalAmount: 0,
                            yearlyAmounts: {},
                            totalPercentage: 0
                        };
                    }
                    
                    // Check if this fund already has an allocation for this year
                    if (masterFunds[symbol].yearlyAmounts[year]) {
                        console.warn(`  Year ${year}: ${symbol} already has allocation for this year: $${masterFunds[symbol].yearlyAmounts[year].toLocaleString()}, adding $${amount.toLocaleString()}`);
                        masterFunds[symbol].totalAmount -= masterFunds[symbol].yearlyAmounts[year]; // Remove previous amount
                    }
                    
                    masterFunds[symbol].totalAmount += amount;
                    masterFunds[symbol].yearlyAmounts[year] = amount;
                });
            }
            
            // Calculate total across all years
            const grandTotal = totalAmountPerYear * 4;
            
            // Sort funds by total amount (largest first)
            const sortedFunds = Object.entries(masterFunds)
                .sort(([,a], [,b]) => b.totalAmount - a.totalAmount);
            
            // Generate master purchase list HTML
            let masterHtml = '<h6 class="mb-3"><i class="fas fa-list"></i> Consolidated Fund Purchase List</h6>';
            
            sortedFunds.forEach(([symbol, data]) => {
                const totalPercentage = (data.totalAmount / grandTotal) * 100;
                console.log(`Processing fund ${symbol}:`, data);
                
                masterHtml += `
                    <div class="row align-items-center mb-3 p-2 border rounded">
                        <div class="col-md-3">
                            <strong class="h6 mb-0">${symbol}</strong>
                            <div class="small text-muted">${data.category}</div>
                        </div>
                        <div class="col-md-3 text-center">
                            <span class="badge bg-success fs-6">$${data.totalAmount.toLocaleString()}</span>
                            <div class="small text-muted">${totalPercentage.toFixed(1)}% of total</div>
                        </div>
                        <div class="col-md-6">
                            <div class="small text-muted">Yearly breakdown:</div>
                            <div class="d-flex flex-wrap">
                `;
                
                for (let year = 1; year <= 4; year++) {
                    const yearAmount = data.yearlyAmounts[year] || 0;
                    console.log(`  Yearly breakdown for ${symbol}: Year ${year} = $${yearAmount.toLocaleString()}`);
                    if (yearAmount > 0) {
                        masterHtml += `
                            <span class="badge bg-secondary me-1 mb-1">
                                Y${year}: $${yearAmount.toLocaleString()}
                            </span>
                        `;
                    }
                }
                
                masterHtml += `
                            </div>
                        </div>
                    </div>
                `;
            });
            
            // Update master purchase list
            document.getElementById('masterPurchaseList').innerHTML = masterHtml;
            
            // Update summary totals
            document.getElementById('totalYear1').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear2').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear3').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('totalYear4').textContent = `$${totalAmountPerYear.toLocaleString()}`;
            document.getElementById('grandTotal').textContent = `$${grandTotal.toLocaleString()}`;
            document.getElementById('uniqueFundCount').textContent = sortedFunds.length;
        }
        
        function copyMasterPurchaseList() {
            const totalAmountPerYear = parseFloat(document.getElementById('investmentAmount').value) || 10000;
            const grandTotal = totalAmountPerYear * 4;
            
            // Collect all fund data
            const masterFunds = {};
            
            for (let year = 1; year <= 4; year++) {
                const fundAllocations = document.querySelectorAll(`[data-timeframe="${year}"].fund-allocation`);
                
                // Track funds seen in this year to prevent duplicates within the same year
                const fundsSeenThisYear = new Set();
                
                fundAllocations.forEach(allocation => {
                    const symbol = allocation.getAttribute('data-symbol');
                    const percentage = parseFloat(allocation.getAttribute('data-allocation'));
                    const category = allocation.getAttribute('data-category');
                    const amount = Math.round(totalAmountPerYear * (percentage / 100));
                    
                    // Check for duplicates within the same year
                    if (fundsSeenThisYear.has(symbol)) {
                        console.warn(`Copy function - Year ${year}: DUPLICATE FUND DETECTED: ${symbol} - skipping duplicate entry`);
                        return; // Skip this duplicate entry
                    }
                    fundsSeenThisYear.add(symbol);
                    
                    if (!masterFunds[symbol]) {
                        masterFunds[symbol] = {
                            category: category,
                            totalAmount: 0,
                            yearlyAmounts: {}
                        };
                    }
                    
                    // Check if this fund already has an allocation for this year
                    if (masterFunds[symbol].yearlyAmounts[year]) {
                        console.warn(`Copy function - Year ${year}: ${symbol} already has allocation for this year: $${masterFunds[symbol].yearlyAmounts[year].toLocaleString()}, adding $${amount.toLocaleString()}`);
                        masterFunds[symbol].totalAmount -= masterFunds[symbol].yearlyAmounts[year]; // Remove previous amount
                    }
                    
                    masterFunds[symbol].totalAmount += amount;
                    masterFunds[symbol].yearlyAmounts[year] = amount;
                });
            }
            
            // Sort by total amount
            const sortedFunds = Object.entries(masterFunds)
                .sort(([,a], [,b]) => b.totalAmount - a.totalAmount);
            
            // Create copy text
            let copyText = `MASTER FUND PURCHASE LIST (Total: $${grandTotal.toLocaleString()})\n`;
            copyText += `‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê\n\n`;
            
            sortedFunds.forEach(([symbol, data]) => {
                const totalPercentage = (data.totalAmount / grandTotal) * 100;
                copyText += `${symbol} (${data.category}): $${data.totalAmount.toLocaleString()} (${totalPercentage.toFixed(1)}%)\n`;
                
                // Add yearly breakdown
                copyText += `  ‚îî‚îÄ Breakdown: `;
                for (let year = 1; year <= 4; year++) {
                    const yearAmount = data.yearlyAmounts[year] || 0;
                    if (yearAmount > 0) {
                        copyText += `Y${year}:$${yearAmount.toLocaleString()} `;
                    }
                }
                copyText += `\n\n`;
            });
            
            copyText += `\nSUMMARY:\n`;
            copyText += `‚Ä¢ Per Year Investment: $${totalAmountPerYear.toLocaleString()}\n`;
            copyText += `‚Ä¢ Total 4-Year Investment: $${grandTotal.toLocaleString()}\n`;
            copyText += `‚Ä¢ Unique Funds: ${sortedFunds.length}\n`;
            copyText += `‚Ä¢ Generated: ${new Date().toLocaleString()}\n`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(copyText).then(() => {
                // Show success feedback
                const btn = event.target;
                const originalText = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check"></i> Copied Master List!';
                btn.className = 'btn btn-success w-100 mt-3';
                
                setTimeout(() => {
                    btn.innerHTML = originalText;
                    btn.className = 'btn btn-warning w-100 mt-3';
                }, 3000);
            }).catch(err => {
                console.error('Failed to copy master list: ', err);
            });
        }
    </script>
</body>
</html>